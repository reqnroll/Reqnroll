<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <_GetReqnrollAssemblyHooksTemplateDependsOn></_GetReqnrollAssemblyHooksTemplateDependsOn>
  </PropertyGroup>

  <!-- Gets the hooks templates that should be used to generate assembly hook sources. -->
  <Target 
    Name="_GetReqnrollAssemblyHooksTemplate"
    DependsOnTargets="$(_GetReqnrollAssemblyHooksTemplateDependsOn)"
    Returns="ReqnrollAssemblyHooksTemplate">

    <PropertyGroup>
      <_ReqnrollEffectiveRootNamespace>$(RootNamespace)</_ReqnrollEffectiveRootNamespace>
      <_ReqnrollEffectiveRootNamespace Condition="'$(_ReqnrollEffectiveRootNamespace)' == ''">Reqnroll.GeneratedTests</_ReqnrollEffectiveRootNamespace>
      <_ReqnrollAssemblyHooksNamespace>$(_ReqnrollEffectiveRootNamespace.Replace('.', '_'))</_ReqnrollAssemblyHooksNamespace>
    </PropertyGroup>
    
    <ItemGroup>
      <ReqnrollAssemblyHooksTemplate Include="$(MSBuildThisFileDirectory)*.AssemblyHooks$(DefaultLanguageSourceExtension)" />
    </ItemGroup>
  </Target>


  <PropertyGroup>
    <GenerateReqnrollAssemblyHooksDependsOn>_GetReqnrollAssemblyHooksTemplate</GenerateReqnrollAssemblyHooksDependsOn>
  </PropertyGroup>

  <!-- Generates assembly hooks using the templates. -->
  <Target
    Name="GenerateReqnrollAssemblyHooks"
    DependsOnTargets="$(GenerateReqnrollAssemblyHooksDependsOn)"
    BeforeTargets="CoreCompile"
    Inputs="@(ReqnrollAssemblyHooksTemplate)"
    Outputs="@(ReqnrollAssemblyHooksTemplate -> '$(IntermediateOutputPath)%(Filename)$(_ReqnrollAssemblyHooksNamespace)%(Extension)')"
    Condition="'$(GenerateReqnrollAssemblyHooksFile)' == 'true'">

    <!-- Read the lines from the template. -->
    <ReadLinesFromFile File="%(ReqnrollAssemblyHooksTemplate.Identity)">
      <Output TaskParameter="Lines" ItemName="_AssemblyHooksTemplateLine" />
    </ReadLinesFromFile>

    <Message Text="Line: %(_AssemblyHooksTemplateLine.Identity)" Importance="high" />

    <!-- Replace the version token. -->
    <ItemGroup>
      <_AssemblyHooksLine Include="@(_AssemblyHooksTemplateLine -> '$([System.String]::Copy(%(Identity)).Replace(`PROJECT_ROOT_NAMESPACE`, `$(_ReqnrollAssemblyHooksNamespace)`))' )" />
    </ItemGroup>

    <PropertyGroup>
      <_ReqnrollAssemblyHookPath>$(IntermediateOutputPath)%(ReqnrollAssemblyHooksTemplate.Filename)$(_ReqnrollAssemblyHooksNamespace)%(ReqnrollAssemblyHooksTemplate.Extension)</_ReqnrollAssemblyHookPath>
    </PropertyGroup>

    <!-- Produce the file. -->
    <WriteLinesToFile
      File="$(_ReqnrollAssemblyHookPath)"
      Lines="@(_AssemblyHooksLine)"
      Overwrite="true"
      Encoding="UTF-8" />
    
    <ItemGroup>
      <!-- Include the generated hooks in the compilation -->
      <Compile Include="$(_ReqnrollAssemblyHookPath)" />

      <!-- Track the file was created during the build so it will be cleaned automatically. -->
      <FileWrites Include="$(_ReqnrollAssemblyHookPath)" />
    </ItemGroup>
  </Target>

</Project>