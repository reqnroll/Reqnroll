<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>

    <_ReqnrollMsTestGeneratorPlugin>netstandard2.0</_ReqnrollMsTestGeneratorPlugin>
    <_ReqnrollMsTestGeneratorPluginPath>$(MSBuildThisFileDirectory)\$(_ReqnrollMsTestGeneratorPlugin)\Reqnroll.MSTest.Generator.ReqnrollPlugin.dll</_ReqnrollMsTestGeneratorPluginPath>

    <_ReqnrollMsTestRuntimePlugin>netstandard2.0</_ReqnrollMsTestRuntimePlugin>
    <_ReqnrollMsTestRuntimePluginPath>$(MSBuildThisFileDirectory)\..\lib\$(_ReqnrollMsTestRuntimePlugin)\Reqnroll.MSTest.ReqnrollPlugin.dll</_ReqnrollMsTestRuntimePluginPath>

    <SourceReqnrollAssemblyHooksFile Condition="'$(SourceReqnrollAssemblyHooksFile)' == ''">$(MSBuildThisFileDirectory)MSTest.AssemblyHooks$(DefaultLanguageSourceExtension)</SourceReqnrollAssemblyHooksFile>
    <GenerateReqnrollAssemblyHooksFile Condition="'$(GenerateReqnrollAssemblyHooksFile)' == ''">true</GenerateReqnrollAssemblyHooksFile>
    <GeneratedReqnrollAssemblyHooksFile>$([System.IO.Path]::Combine($(ProjectDir),$([MSBuild]::Unescape('$(IntermediateOutputPath)'))))MSTest.AssemblyHooks$(DefaultLanguageSourceExtension)</GeneratedReqnrollAssemblyHooksFile>
    <_ReqnrollEffectiveRootNamespace Condition="'$(RootNamespace)' != ''">$(RootNamespace)</_ReqnrollEffectiveRootNamespace>
    <_ReqnrollEffectiveRootNamespace Condition="'$(RootNamespace)' == ''">Reqnroll.GeneratedTests</_ReqnrollEffectiveRootNamespace>
  </PropertyGroup>

  <Target
    Name="GenerateReqnrollAssemblyHooksFileTask"
    Condition="'$(GenerateReqnrollAssemblyHooksFile)' == 'true' AND '$(_ReqnrollToolsMsBuildGenerationImported)' == 'true'"
    BeforeTargets="CoreCompile">
    
    <ReplaceTokenInFileTask
      Condition="'$(Language)' == 'VB' or '$(Language)' == 'C#'"
      InputFile="$(SourceReqnrollAssemblyHooksFile)"
      OutputFile="$(GeneratedReqnrollAssemblyHooksFile)"
      TextToReplace="PROJECT_ROOT_NAMESPACE"
      TextToReplaceWith="$(_ReqnrollEffectiveRootNamespace.Replace('.', '_'))"
      WriteOnlyWhenChanged="true" />
    
    <ItemGroup Condition="'$(Language)' == 'VB' or '$(Language)' == 'C#'">
      <Compile Include="$(GeneratedReqnrollAssemblyHooksFile)"/>
    </ItemGroup>
  </Target>

  <Target Name="SetPluginParameters" BeforeTargets="UpdateFeatureFilesInProject">
    <PropertyGroup>
      <!-- Detect the version of MSTest.TestFramework package and pass it to the plugin. -->
      <!-- The property can be overridden for special cases in the project file. -->
      <_MsTestFrameworkVersion Condition="'$(_MsTestFrameworkVersion)' == ''">@(ReferencePath->WithMetadataValue('NuGetPackageId', 'MSTest.TestFramework')->'%(NuGetPackageVersion)')</_MsTestFrameworkVersion>
    </PropertyGroup>

    <ItemGroup>
      <ReqnrollGeneratorPlugins Update="$(_ReqnrollMsTestGeneratorPluginPath)">
        <Parameter_TargetMsTestVersion>$(_MsTestFrameworkVersion)</Parameter_TargetMsTestVersion>
      </ReqnrollGeneratorPlugins>
    </ItemGroup>
  </Target>


</Project>