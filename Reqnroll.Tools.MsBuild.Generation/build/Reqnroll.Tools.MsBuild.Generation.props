<Project TreatAsLocalProperty="TaskFolder;TaskAssembly">

  <PropertyGroup>
    <ReqnrollGenerationPropsImported>true</ReqnrollGenerationPropsImported>
    <ReqnrollCpsExtensionDesignTimeTargetsPath Condition="'$(ReqnrollCpsExtensionDesignTimeTargetsPath)' == ''">$(MSBuildThisFileDirectory)CPS\Buildsystem\CpsExtension.DesignTime.targets</ReqnrollCpsExtensionDesignTimeTargetsPath>
  </PropertyGroup>

  <Import Project="$(ReqnrollCpsExtensionDesignTimeTargetsPath)" Condition="'$(DesignTimeBuild)' == 'true' " />

  <PropertyGroup>
    <ReqnrollGenerationTasksPath Condition="'$(ReqnrollGenerationTasksPath)' == '' And '$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)netstandard2.0/</ReqnrollGenerationTasksPath>
    <ReqnrollGenerationTasksPath Condition="'$(ReqnrollGenerationTasksPath)' == ''">$(MSBuildThisFileDirectory)net462/</ReqnrollGenerationTasksPath>
    <ReqnrollGenerationTasksAssemblyFilename Condition=" '$(ReqnrollGenerationTasksAssemblyFilename)' == '' ">Reqnroll.Tools.MsBuild.Generation.dll</ReqnrollGenerationTasksAssemblyFilename>
    <ReqnrollGenerationTasksAssemblyPath Condition=" '$(ReqnrollGenerationTasksAssemblyPath)' == '' ">$(ReqnrollGenerationTasksPath)$(ReqnrollGenerationTasksAssemblyFilename)</ReqnrollGenerationTasksAssemblyPath>

    <!-- Using `TaskHostFactory` ensures that the task assembly will not be locked by Visual Studio on Windows. See: https://learn.microsoft.com/en-us/visualstudio/msbuild/how-to-configure-targets-and-tasks?view=vs-2022#task-factories -->
    <!-- Note: `TaskHostFactory` is not compatible with some macOS versions. https://github.com/reqnroll/Reqnroll/issues/152 -->
    <ReqnrollGenerationTaskFactory Condition="'$(ReqnrollGenerationTaskFactory)' == '' And $([MSBuild]::IsOsPlatform('Windows'))">TaskHostFactory</ReqnrollGenerationTaskFactory>
    <ReqnrollGenerationTaskFactory Condition="'$(ReqnrollGenerationTaskFactory)' == ''">AssemblyTaskFactory</ReqnrollGenerationTaskFactory>
  </PropertyGroup>

  <PropertyGroup>
    <ReqnrollUseHostCompilerIfAvailable Condition="'$(ReqnrollUseHostCompilerIfAvailable)'==''">false</ReqnrollUseHostCompilerIfAvailable>
    <UseHostCompilerIfAvailable>$(ReqnrollUseHostCompilerIfAvailable)</UseHostCompilerIfAvailable>
  </PropertyGroup>

  <!--
    property group for internal or debug settings
  -->
  <PropertyGroup>
    <ReqnrollDebugMSBuildTask Condition="'$(ReqnrollDebugMSBuildTask)' == ''">false</ReqnrollDebugMSBuildTask>
  </PropertyGroup>

  <!--
    property group for feature flags
  -->
  <PropertyGroup>

    <!--
      feature flag to enable/disable removing code-behind files during clean
    -->
    <ReqnrollDeleteCodeBehindFilesOnClean Condition="'$(ReqnrollDeleteCodeBehindFilesOnClean)'==''">true</ReqnrollDeleteCodeBehindFilesOnClean>

    <!--
      feature flag to enable embedding of feature files as resources in the assembly
    -->
    <!--<ReqnrollEmbedFeatureFiles Condition="'$(ReqnrollEmbedFeatureFiles)'==''">false</ReqnrollEmbedFeatureFiles>-->

    <!--
      net.sdk support: feature flag to enable experimental support for net.sdk project system
    -->
    <ReqnrollEnableDefaultCompileItems Condition="'$(ReqnrollEnableDefaultCompileItems)'==''">true</ReqnrollEnableDefaultCompileItems>
    <ReqnrollEnableWarnForFeatureCodeBehindFilesWithoutCorrespondingFeatureFile Condition="'$(ReqnrollEnableWarnForFeatureCodeBehindFilesWithoutCorrespondingFeatureFile)'==''">$(ReqnrollEnableDefaultCompileItems)</ReqnrollEnableWarnForFeatureCodeBehindFilesWithoutCorrespondingFeatureFile>

    <DefaultItemExcludes>$(DefaultItemExcludes);**/*.feature</DefaultItemExcludes>
  </PropertyGroup>

  <ItemGroup>

    <!-- Registration of custom item type for ReSharper Build -->
    <!-- https://www.jetbrains.com/help/resharper/Building_Solution.html#supported-build-items -->
    <AvailableItemName Include="ReqnrollFeatureFiles"/>
    
    <ReqnrollFeatureFiles Include="**\*.feature" >
      <CodeBehindFile>%(RelativeDir)%(Filename).feature$(DefaultLanguageSourceExtension)</CodeBehindFile>
      <MessagesFile>$(IntermediateOutputPath)%(RelativeDir)%(Filename).feature.ndjson</MessagesFile>
      <Visible>$(UsingMicrosoftNETSdk)</Visible>
      <NormalizedLogicalName>$([System.String]::Copy('%(Identity)').Replace('\','/'))</NormalizedLogicalName>
    </ReqnrollFeatureFiles>

    <!-- obsolete codebehind files, scenarios:
         - after rename operation
         - after deletion of a feature file
         - after pulling latest changes from version control with above changes
     -->
    <ReqnrollObsoleteCodeBehindFiles Include="**\*.feature$(DefaultLanguageSourceExtension)" Exclude="@(ReqnrollFeatureFiles->'%(CodeBehindFile)')" />

    <!-- Support for Visual Studio Incremental Build
        https://web.archive.org/web/20200926191113/https://github.com/SpecFlowOSS/SpecFlow/issues/1319
        
        TODO: Temporarily disabled, because it seems to work correctly without it in the new SDK-based projects. We need to
              re-evaluate this for different projects.
              
        NOTE: The property 'UpToDateCheckBuild' was anyway wrong because it should have been called 'UpToDateCheckBuilt'. See https://github.com/reqnroll/Reqnroll/issues/906
     -->
    <!--<UpToDateCheckInput Include="@(ReqnrollFeatureFiles)" />-->
    <!--<UpToDateCheckBuild Include="@(ReqnrollFeatureFiles->'%(CodeBehindFile)')" Original="@(ReqnrollFeatureFiles)" />-->
    <!--<CustomAdditionalCompileInputs Include="@(ReqnrollFeatureFiles->'%(CodeBehindFile)')" />-->

  </ItemGroup>

  <PropertyGroup>
    <ReqnrollConfigFile Condition="Exists('reqnroll.json')">reqnroll.json</ReqnrollConfigFile>
  </PropertyGroup>

</Project>
