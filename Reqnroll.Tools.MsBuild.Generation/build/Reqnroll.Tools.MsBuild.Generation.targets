<Project>

  <PropertyGroup>
    <_ReqnrollToolsMsBuildGenerationImported>true</_ReqnrollToolsMsBuildGenerationImported>
  </PropertyGroup>

  <UsingTask
    TaskName="Reqnroll.Tools.MsBuild.Generation.GenerateFeatureFileCodeBehindTask"
    AssemblyFile="$(ReqnrollGenerationTasksAssemblyPath)"
    TaskFactory="$(ReqnrollGenerationTaskFactory)" />
  
  <UsingTask
    TaskName="Reqnroll.Tools.MsBuild.Generation.ReplaceTokenInFileTask"
    AssemblyFile="$(ReqnrollGenerationTasksAssemblyPath)"
    TaskFactory="$(ReqnrollGenerationTaskFactory)" />

  <PropertyGroup Condition="'$(BuildServerMode)' == ''">
    <BuildServerMode Condition="'$(BuildingInsideVisualStudio)'=='true'">false</BuildServerMode>
    <BuildServerMode Condition="'$(BuildingInsideVisualStudio)'!='true'">true</BuildServerMode>

    <!-- .NET SDK support: tracks whether the code-behind files are included to the project implicitly (without mentioning them in the project file) -->
    <!-- This is the default behavior for SDK-style projects, unless EnableDefaultItems/EnableDefaultCompileItems is disabled by the user  -->
    <_ReqnrollImplicitlyIncludedCodeBehindFiles Condition="'$(UsingMicrosoftNETSdk)' == 'true' and '$(EnableDefaultItems)' == 'true' and '$(EnableDefaultCompileItems)' == 'true'">true</_ReqnrollImplicitlyIncludedCodeBehindFiles>
  </PropertyGroup>

  <PropertyGroup>
    <CleanDependsOn>
      CleanFeatureFilesInProject;
      $(CleanDependsOn)
    </CleanDependsOn>
  </PropertyGroup>

  <!--
    Show code-behind files as nested items under feature files in Visual Studio Solution Explorer
  -->
  <ItemGroup Condition="'$(_ReqnrollImplicitlyIncludedCodeBehindFiles)' == 'true'">
    <Compile Update="@(ReqnrollFeatureFiles->'%(CodeBehindFile)')" DependentUpon="%(Filename)" />
  </ItemGroup>

  <Target Name="WarnForFeatureCodeBehindFilesWithoutCorrespondingFeatureFile" AfterTargets="CoreCompile"
          Condition="'$(ReqnrollEnableWarnForFeatureCodeBehindFilesWithoutCorrespondingFeatureFile)' == 'true'">
    <Warning Text="For codebehind file '@(ReqnrollObsoleteCodeBehindFiles)', no feature file was found. Perform a 'Clean' or 'Rebuild' operation to get these obsolete files deleted." File="@(ReqnrollObsoleteCodeBehindFiles)" Condition="'@(ReqnrollObsoleteCodeBehindFiles)' != ''" />
  </Target>

  <Target Name="ProcessFeatureFilesInProject"
          BeforeTargets="BeforeCompile;CoreCompile"
          DependsOnTargets="PrepareForBuild;CoreProcessFeatureFilesInProject" />

  <Target Name="CoreProcessFeatureFilesInProject"
          Inputs="@(ReqnrollFeatureFiles);$(MSBuildProjectFullPath);$(ReqnrollConfigFile)"
          Outputs="@(ReqnrollFeatureFiles -> '%(CodeBehindFile)')">

    <Message Text="[Reqnroll] FeatureFiles: @(ReqnrollFeatureFiles)" Importance="normal" />

    <Error
      Text="Reqnroll designer codebehind generation is not compatible with MSBuild codebehind generation. The custom tool must be removed from the file. See https://www.reqnroll.net/documentation/Generate-Tests-from-MsBuild"
      File="@(None)"
      Condition="%(None.Extension) == '.feature' AND %(None.Generator) == 'ReqnrollSingleFileGenerator'"/>

    <PropertyGroup Condition="'$(TargetFrameworkVersion)' != ''">
      <ReqnrollTargetFramework>$(TargetFrameworkVersion)</ReqnrollTargetFramework>
    </PropertyGroup>
    <PropertyGroup Condition="'$(TargetFramework)' != ''">
      <ReqnrollTargetFramework>$(TargetFramework)</ReqnrollTargetFramework>
      <ReqnrollTargetFrameworks>$(TargetFramework)</ReqnrollTargetFrameworks>
    </PropertyGroup>
    <PropertyGroup Condition="'$(TargetFrameworks)' != ''">
      <ReqnrollTargetFrameworks>$(TargetFrameworks)</ReqnrollTargetFrameworks>
    </PropertyGroup>

    <GenerateFeatureFileCodeBehindTask
      ProjectPath="$(MSBuildProjectFullPath)"
      OutputPath="$(ReqnrollCodeBehindOutputPath)"
      FeatureFiles="@(ReqnrollFeatureFiles)"
      RootNamespace="$(RootNamespace)"
      GeneratorPlugins="@(ReqnrollGeneratorPlugins)" 
      
      MSBuildVersion="$(MSBuildVersion)"
      AssemblyName="$(AssemblyName)"
      TargetFrameworks="$(ReqnrollTargetFrameworks)"
      TargetFramework="$(ReqnrollTargetFramework)"
      ProjectGuid="$(ProjectGuid)"
      LaunchDebugger="$(ReqnrollDebugMSBuildTask)"
      >

      <Output TaskParameter="GeneratedFiles" ItemName="ReqnrollGeneratedFiles" />
    </GenerateFeatureFileCodeBehindTask>

    <Message Text="[Reqnroll] Generated code-behind file: %(ReqnrollGeneratedFiles.Identity)" Importance="normal" />
    <Message Text="[Reqnroll] Generated messages file: %(ReqnrollGeneratedFiles.MessagesFile)" Condition="'%(ReqnrollGeneratedFiles.MessagesFile)' != ''" Importance="normal" />

    <!--
      Include newly generated codebehind files in the compile item group
    -->
    <ItemGroup Condition="'$(_ReqnrollImplicitlyIncludedCodeBehindFiles)' == 'true'">

      <!-- if this is the first time generation of codebehind files, we have to manually add them as compile items -->
      <Compile Include="@(ReqnrollFeatureFiles->'%(CodeBehindFile)')"
               Exclude="@(Compile)"/>

      <!-- remove files which got obsolete, typically after rename operation, or getting changes from source control -->
      <Compile Remove="@(ReqnrollObsoleteCodeBehindFiles)" />
    </ItemGroup>

    <ItemGroup Condition="'$(ReqnrollEmbedFeatureFiles)' == 'true'">
      <EmbeddedResource Include="@(ReqnrollFeatureFiles)">
        <LogicalName>%(ReqnrollFeatureFiles.NormalizedLogicalName)</LogicalName>
      </EmbeddedResource>
    </ItemGroup>

  </Target>

  <PropertyGroup>
    <AssignTargetPathsDependsOn>
      EmbedCucumberMessages;
      $(AssignTargetPathsDependsOn)
    </AssignTargetPathsDependsOn>
  </PropertyGroup>

  <Target Name="EmbedCucumberMessages" DependsOnTargets="CoreProcessFeatureFilesInProject">

    <ItemGroup>
      <EmbeddedResource Include="@(ReqnrollGeneratedFiles->'%(MessagesFile)')" Condition="'%(ReqnrollGeneratedFiles.MessagesFile)' != ''">
        <LogicalName>%(ReqnrollGeneratedFiles.MessagesResourceName)</LogicalName>
      </EmbeddedResource>
    </ItemGroup>
  </Target>

  <Target Name="CleanFeatureFilesInProject">
    <!-- remove known codebehind files for existing feature files -->
    <Delete Files="%(ReqnrollFeatureFiles.CodeBehindFile)" ContinueOnError="true" />

    <!-- remove obsolete codebehind files, scenarios:
         - after rename operation
         - after deletion of a feature file
         - after pulling latest changes from version control with above changes
     -->
    <Delete Files="@(ReqnrollObsoleteCodeBehindFiles)" ContinueOnError="true" />
    <ItemGroup>
      <Compile Remove="@(ReqnrollObsoleteCodeBehindFiles)" />
      <ReqnrollObsoleteCodeBehindFiles Remove="@(ReqnrollObsoleteCodeBehindFiles)" />
    </ItemGroup>
  </Target>
</Project>