#nullable enable

using Cucumber.HtmlFormatter;
using Io.Cucumber.Messages.Types;
using Reqnroll.Formatters.Configuration;
using Reqnroll.Formatters.PayloadProcessing;
using Reqnroll.Formatters.RuntimeSupport;
using Reqnroll.Utils;
using System;
using System.IO;
using System.Threading;
using System.Threading.Tasks;

namespace Reqnroll.Formatters.Html;

/// <summary>
/// Produces an HTML report file based on https://github.com/cucumber/html-formatter/ and https://github.com/cucumber/react-components.
/// </summary>
public class HtmlFormatter : FileWritingFormatterBase
{
    private MessagesToHtmlWriter? _htmlWriter;

    protected HtmlFormatter(IFormattersConfigurationProvider configurationProvider, IFormatterLog logger, IFileSystem fileSystem, string pluginName) : 
        base(configurationProvider, logger, fileSystem, pluginName, ".html", "reqnroll_report.html")
    {
    }

    public HtmlFormatter(IFormattersConfigurationProvider configurationProvider, IFormatterLog logger, IFileSystem fileSystem) : 
        this(configurationProvider, logger, fileSystem, "html")
    {
    }

    protected virtual MessagesToHtmlWriter CreateMessagesToHtmlWriter(Stream stream, Func<StreamWriter, Envelope, Task> asyncStreamSerializer) 
        => new(stream, asyncStreamSerializer, GetHtmlReportSettings());

    protected virtual HtmlReportSettings GetHtmlReportSettings()
    {
        return new HtmlReportSettings
        {
            Title = $"Reqnroll Report {DateTime.Now:u}",
            Icon = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgdmVyc2lvbj0iMS4xIgogICBpZD0ic3ZnODQyIgogICB4bWw6c3BhY2U9InByZXNlcnZlIgogICB3aWR0aD0iOTkiCiAgIGhlaWdodD0iOTkiCiAgIHZpZXdCb3g9IjAgMCA5OSA5OSIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiCiAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyI+PG1ldGFkYXRhCiAgICAgaWQ9Im1ldGFkYXRhODQ4Ij48cmRmOlJERj48Y2M6V29yawogICAgICAgICByZGY6YWJvdXQ9IiI+PGRjOmZvcm1hdD5pbWFnZS9zdmcreG1sPC9kYzpmb3JtYXQ+PGRjOnR5cGUKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly9wdXJsLm9yZy9kYy9kY21pdHlwZS9TdGlsbEltYWdlIiAvPjwvY2M6V29yaz48L3JkZjpSREY+PC9tZXRhZGF0YT48ZGVmcwogICAgIGlkPSJkZWZzODQ2IiAvPjxjaXJjbGUKICAgICBzdHlsZT0iZGlzcGxheTppbmxpbmU7ZmlsbDojZmZmZmZmO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDowLjU1NDE0OTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdG9wLWNvbG9yOiMwMDAwMDAiCiAgICAgaWQ9ImNpcmNsZTg2MyIKICAgICBjeD0iNDQuNSIKICAgICBjeT0iNDQiCiAgICAgcj0iNDQiCiAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNSw1KSIgLz48ZwogICAgIGlkPSJnODUyIgogICAgIHN0eWxlPSJkaXNwbGF5OmlubGluZSIKICAgICB0cmFuc2Zvcm09Im1hdHJpeCgxLjMzMzMzMzMsMCwwLDEuMzMzMzMzMyw1LDUuMDAwMDAxOSkiPjxwYXRoCiAgICAgICBkPSJtIDMuNzE5LDMzLjM3NSBjIDAsLTE2LjM3OSAxMy4yNzcsLTI5LjY1NiAyOS42NTYsLTI5LjY1NiAxNi4zNzksMCAyOS42NTYsMTMuMjc3IDI5LjY1NiwyOS42NTYgMCwxNi4zNzkgLTEzLjI3NywyOS42NTYgLTI5LjY1NiwyOS42NTYgQyAxNi45OTYsNjMuMDMxIDMuNzE5LDQ5Ljc1NCAzLjcxOSwzMy4zNzUgWiBNIDQ2LjAwNCwyMC40NzcgViA5Ljk3NyBMIDQzLjc4NSw5LjgwOSBjIC00LjA5NywwIC03LjkxLDAuOTk2IC0xMS40MzcsMi45ODQgLTMuNjQ1LDIuMDUxIC02LjUwNCw0Ljc5NyAtOC41NzgsOC4yMzggLTIuMDc5LDMuNDQ2IC0zLjExOCw3LjE4NCAtMy4xMTgsMTEuMjI3IGwgMC4wODYsMjQuNDk2IGggOS45ODkgTCAzMC41NTUsMzMuNzkzIGMgMCwtMi41MDQgMC42MjUsLTQuNzUgMS44NzksLTYuNzQyIDEuMTk1LC0yLjA1MSAyLjgyOCwtMy42ODggNC45MDYsLTQuOTEgMi4wNzgsLTEuMjIzIDQuMzEyLC0xLjgzNiA2LjY5OSwtMS44MzYgMC4yODUsMCAwLjk0MSwwLjA1OCAxLjk2NSwwLjE3MiB6IG0gMjAuNzM4LDEzLjU1NCAtMC4wMDgsMC4zMzYgLTAuMDA3LDAuMzMyIC0wLjAxNiwwLjMzMiAtMC4wMiwwLjMzNiAtMC4wMTksMC4zMzIgLTAuMDI0LDAuMzMyIC0wLjAyNywwLjMzMiAtMC4wMzEsMC4zMzIgLTAuMDcsMC42NjQgLTAuMDg2LDAuNjY0IC0wLjA0NywwLjMyOSAtMC4wNTEsMC4zMzIgLTAuMDU1LDAuMzI4IC0wLjExNywwLjY1NiAtMC4xMzMsMC42NTYgLTAuMDcsMC4zMjQgLTAuMDc0LDAuMzI5IC0wLjA3OCwwLjMyNCAtMC4xNjQsMC42NDggLTAuMTgsMC42NDEgLTAuMDk0LDAuMzIgLTAuMDk4LDAuMzIgLTAuMTAxLDAuMzIxIC0wLjEwMiwwLjMxNiAtMC4yMTgsMC42MzMgLTAuMTE0LDAuMzEyIC0wLjIzNCwwLjYyNiAtMC4xMjEsMC4zMDggLTAuMTI1LDAuMzA5IC0wLjEyOSwwLjMwOCAtMC4wNzgsMC4xOCAtMC4xMzMsMC4zMDEgLTAuMTMzLDAuMzA0IC0wLjE0LDAuMzA1IC0wLjE0MSwwLjMwMSAtMC4xNDksMC4zMDEgLTAuMTQ0LDAuMyAtMC4xNTIsMC4yOTcgLTAuMTU3LDAuMjk3IC0wLjE1NiwwLjI5MyAtMC4zMiwwLjU4NiAtMC4zMzYsMC41NzggLTAuMTcyLDAuMjg1IC0wLjE3NiwwLjI4NiAtMC4xNzYsMC4yODEgLTAuMTc5LDAuMjgxIC0wLjE4NCwwLjI4MSAtMC4xODcsMC4yNzggLTAuMTg4LDAuMjczIC0wLjE5MSwwLjI3NCAtMC4xOTYsMC4yNzMgLTAuMTk5LDAuMjY2IC0wLjE5OSwwLjI2OSAtMC4yMDMsMC4yNjYgLTAuMjAzLDAuMjYxIC0wLjIwNywwLjI2MiAtMC4yMTEsMC4yNjIgLTAuMjE1LDAuMjU0IC0wLjIxNSwwLjI1OCAtMC40MzcsMC41IC0wLjIyMywwLjI1IC0wLjIyNywwLjI0NiAtMC4yMjYsMC4yNDIgLTAuMjMxLDAuMjQyIC0wLjQ2OCwwLjQ3NyAtMC4xMzcsMC4xMzYgLTAuMjM1LDAuMjMxIC0wLjQ4NCwwLjQ2MSAtMC4yNDYsMC4yMjYgLTAuMjQ2LDAuMjIzIC0wLjI1LDAuMjIzIC0wLjI1LDAuMjE4IC0wLjI1NCwwLjIxNSAtMC4yNTgsMC4yMTUgLTAuMjU4LDAuMjExIC0wLjI2MSwwLjIxMSAtMC4yNjIsMC4yMDcgLTAuMjYyLDAuMjAzIC0wLjI2OSwwLjE5OSAtMC4yNjYsMC4yIC0wLjI3MywwLjE5NSAtMC4yNywwLjE5NSAtMC4yNzcsMC4xODggLTAuMjc0LDAuMTg3IC0wLjI4MSwwLjE4OCAtMC4yNzcsMC4xNzkgLTAuMjgyLDAuMTggLTAuMjg1LDAuMTc2IC0wLjI4NSwwLjE3MiAtMC4yODksMC4xNzIgLTAuMjg5LDAuMTY4IC0wLjI4OSwwLjE2NCAtMC4yOTMsMC4xNiAtMC4yOTMsMC4xNTYgLTAuMjk3LDAuMTU2IC0wLjI5NywwLjE1MyAtMC4yOTcsMC4xNDggLTAuMywwLjE0OSAtMC4zMDEsMC4xNDQgLTAuMzA1LDAuMTQxIC0wLjMwMSwwLjEzNiAtMC4zMDgsMC4xMzMgLTAuMzA1LDAuMTMzIC0wLjMwNSwwLjEyNSAtMC42MTcsMC4yNSAtMC42MjUsMC4yMzQgLTAuMzEyLDAuMTE0IC0wLjYzMywwLjIxOCAtMC4zMTcsMC4xMDIgLTAuMzIsMC4xMDIgLTAuMzE2LDAuMDk3IC0wLjMyMSwwLjA5NCAtMC4zMjQsMC4wOSAtMC4zMiwwLjA5IC0wLjY0OSwwLjE2NCAtMC4zMjQsMC4wNzggLTAuMzI0LDAuMDc0IC0wLjMyOCwwLjA3IC0wLjMyNCwwLjA2NyAtMC4zMjgsMC4wNjYgLTAuMzI5LDAuMDU5IC0wLjMzMiwwLjA1OCAtMC4zMjgsMC4wNTUgLTAuMzI4LDAuMDUxIC0wLjY2NCwwLjA5NCAtMC4zMjgsMC4wMzkgLTAuMzMyLDAuMDM5IC0wLjMzMiwwLjAzNSAtMC4zMzIsMC4wMzEgLTAuMzM2LDAuMDI3IC0wLjMzMiwwLjAyNCAtMC42NjQsMC4wMzkgLTAuMzM2LDAuMDE2IC0wLjY2NCwwLjAxNSAtMC4zMzYsMC4wMDggaCAtMC42NiBMIDMyLjcxOSw2Ni43NDIgMzIuMzgzLDY2LjczNCAzMi4wNTEsNjYuNzI3IDMxLjcxOSw2Ni43MTEgMzEuMzgzLDY2LjY5MSAzMS4wNTEsNjYuNjcyIDMwLjcxOSw2Ni42NDggMzAuMzg3LDY2LjYyMSAzMC4wNTUsNjYuNTkgMjkuMzkxLDY2LjUyIDI4LjcyNyw2Ni40MzQgMjguMzk4LDY2LjM4NyAyOC4wNjYsNjYuMzM2IDI3LjczOCw2Ni4yODEgMjcuMDgyLDY2LjE2NCAyNi40MjYsNjYuMDMxIDI2LjEwMiw2NS45NjEgMjUuNzczLDY1Ljg4NyAyNS40NDksNjUuODA5IDI0LjgwMSw2NS42NDUgMjQuMTYsNjUuNDY1IDIzLjg0LDY1LjM3MSAyMy41Miw2NS4yNzMgMjMuMTk5LDY1LjE3MiAyMi44ODMsNjUuMDcgMjIuNTY2LDY0Ljk2MSAyMi4yNTQsNjQuODUyIDIxLjkzOCw2NC43MzggMjEuMzEyLDY0LjUwNCAyMS4wMDQsNjQuMzgzIDIwLjY5NSw2NC4yNTggMjAuMzg3LDY0LjEyOSAyMC4yMTEsNjQuMDUxIDE5LjYwMiw2My43ODUgMTkuMjk3LDYzLjY0NSAxOC45OTYsNjMuNTA0IDE4LjM5NSw2My4yMDcgMTguMDk4LDYzLjA1OSAxNy44MDEsNjIuOTAyIDE3LjUwOCw2Mi43NDYgMTYuOTIyLDYyLjQyNiAxNi4zNDQsNjIuMDkgMTYuMDU5LDYxLjkxOCAxNS43NzMsNjEuNzQyIDE1LjQ5Miw2MS41NjYgMTUuMjExLDYxLjM4NyAxNC45Myw2MS4yMDMgMTQuNjUyLDYxLjAxNiAxNC4zNzksNjAuODI4IDE0LjEwNSw2MC42MzcgMTMuODM2LDYwLjQ0MSAxMy4yOTcsNjAuMDQzIDEzLjAzMSw1OS44NCAxMi43Nyw1OS42MzcgMTIuNTA4LDU5LjQzIDEyLjI1LDU5LjIxOSAxMS45OTIsNTkuMDA0IDExLjczOCw1OC43ODkgMTEuNDg0LDU4LjU3IDExLjIzNCw1OC4zNTIgMTAuOTg0LDU4LjEyOSAxMC43MzgsNTcuOTAyIDEwLjQ5Niw1Ny42NzYgMTAuMjU0LDU3LjQ0NSA5Ljc3Nyw1Ni45NzcgOS42NDEsNTYuODQgOS40MSw1Ni42MDUgOC45NDksNTYuMTIxIDguNzIzLDU1Ljg3NSA4LjUsNTUuNjI5IDguMjc3LDU1LjM3OSA4LjA1OSw1NS4xMjkgNy44NDQsNTQuODc1IDcuNjI5LDU0LjYxNyA3LjQxOCw1NC4zNTkgNy4yMDcsNTQuMDk4IDcsNTMuODM2IDYuNzk3LDUzLjU3NCA2LjU5OCw1My4zMDUgNi4zOTgsNTMuMDM5IDYuMjAzLDUyLjc2NiA2LjAwOCw1Mi40OTYgNS44Miw1Mi4yMTkgNS42MzMsNTEuOTQ1IDUuNDQ5LDUxLjY2NCA1LjI2Niw1MS4zODcgNS4wODYsNTEuMTA1IDQuOTEsNTAuODIgNC43MzgsNTAuNTM1IDQuNTY2LDUwLjI0NiA0LjQwMiw0OS45NTcgNC4yMzQsNDkuNjY4IDQuMDc0LDQ5LjM3NSAzLjkxOCw0OS4wODIgMy43NjIsNDguNzg1IDMuNjA5LDQ4LjQ4OCAzLjQ2MSw0OC4xOTEgMy4zMTIsNDcuODkxIDMuMTY4LDQ3LjU5IDMuMDI3LDQ3LjI4NSAyLjg5MSw0Ni45ODQgMi43NTgsNDYuNjc2IDIuNjI1LDQ2LjM3MSAyLjUsNDYuMDY2IDIuMjUsNDUuNDQ5IDIuMDE2LDQ0LjgyNCAxLjkwMiw0NC41MTIgMS42ODQsNDMuODc5IDEuNTgyLDQzLjU2MiAxLjQ4LDQzLjI0MiAxLjM4Myw0Mi45MjYgMS4yODksNDIuNjA1IDEuMTk5LDQyLjI4MSAxLjEwOSw0MS45NjEgMC45NDUsNDEuMzEyIDAuODY3LDQwLjk4OCAwLjc5Myw0MC42NjQgMC43MjMsNDAuMzM2IDAuNjU2LDQwLjAxMiAwLjU5LDM5LjY4NCAwLjUzMSwzOS4zNTUgMC40NzMsMzkuMDIzIDAuNDE4LDM4LjY5NSAwLjM2NywzOC4zNjcgMC4yNzMsMzcuNzAzIDAuMjM0LDM3LjM3NSAwLjE5NSwzNy4wNDMgMC4xNiwzNi43MTEgMC4xMzMsMzYuMzc5IDAuMTAyLDM2LjA0MyAwLjA3OCwzNS43MTEgMC4wMzksMzUuMDQ3IDAuMDI3LDM0LjcxMSAwLjAxNiwzNC4zNzkgMC4wMDgsMzQuMDQ3IDAsMzMuNzExIHYgLTAuNjYgbCAwLjAwOCwtMC4zMzIgMC4wMDgsLTAuMzM2IDAuMDA3LC0wLjMzMiAwLjAxNiwtMC4zMzIgMC4wMiwtMC4zMzYgMC4wMTksLTAuMzMyIDAuMDI0LC0wLjMzMiAwLjAyNywtMC4zMzIgMC4wMzEsLTAuMzMyIDAuMDcsLTAuNjY0IDAuMDg2LC0wLjY2NCAwLjA0NywtMC4zMjkgMC4wNTEsLTAuMzMyIDAuMDU1LC0wLjMyOCAwLjA1OCwtMC4zMjggMC4xMjUsLTAuNjU2IDAuMDY3LC0wLjMyOCAwLjA3LC0wLjMyNCAwLjA3NCwtMC4zMjkgMC4wNzgsLTAuMzI0IDAuMDgyLC0wLjMyNCAwLjA4NiwtMC4zMjQgMC4wODYsLTAuMzIxIDAuMDksLTAuMzIgMC4wOTQsLTAuMzIgMC4wOTgsLTAuMzIgMC4xMDEsLTAuMzIxIDAuMTAyLC0wLjMxNiAwLjEwOSwtMC4zMTcgMC4xMDksLTAuMzEyIDAuMTE0LC0wLjMxNiAwLjIzNCwtMC42MjYgMC4xMjEsLTAuMzA4IDAuMTI5LC0wLjMwOSAwLjEyNSwtMC4zMDggMC4wNzgsLTAuMTggMC4xMzMsLTAuMzAxIDAuMjczLC0wLjYwOSAwLjI5LC0wLjYwMiAwLjE0OCwtMC4zIDAuMTQ4LC0wLjI5NyAwLjE1NywtMC4yOTcgMC4xNTYsLTAuMjkzIDAuMTYsLTAuMjkzIEwgNC4zMjgsMTYuOTIyIDQuNDkyLDE2LjYzMyA0LjY2LDE2LjM0NCA0LjgzMiwxNi4wNTkgNS4wMDgsMTUuNzczIDUuMTg0LDE1LjQ5MiA1LjM2MywxNS4yMTEgNS41NDcsMTQuOTMgNS43MzQsMTQuNjUyIDUuOTIyLDE0LjM3OSA2LjExMywxNC4xMDUgNi4zMDksMTMuODM2IDYuNzA3LDEzLjI5NyA2LjkxLDEzLjAzMSA3LjExMywxMi43NyA3LjMyLDEyLjUwOCA3LjUzMSwxMi4yNSA3Ljc0NiwxMS45OTIgNy45NjEsMTEuNzM4IDguMTgsMTEuNDg0IDguMzk4LDExLjIzNCA4LjYyMSwxMC45ODQgOC44NDgsMTAuNzM4IDkuMDc0LDEwLjQ5NiA5LjMwNSwxMC4yNTQgOS43NzMsOS43NzcgOS45MSw5LjY0MSAxMC4xNDUsOS40MSAxMC42MjksOC45NDkgMTAuODc1LDguNzIzIDExLjEyMSw4LjUgMTEuMzcxLDguMjc3IDExLjYyMSw4LjA1OSAxMS44NzUsNy44NDQgMTIuMTMzLDcuNjI5IDEyLjM5MSw3LjQxOCAxMi42NTIsNy4yMDcgMTIuOTE0LDcgMTMuMTc2LDYuNzk3IDEzLjQ0NSw2LjU5OCAxMy43MTEsNi4zOTggMTMuOTg0LDYuMjAzIDE0LjI1NCw2LjAwOCAxNC41MzEsNS44MiAxNC44MDUsNS42MzMgMTUuMDg2LDUuNDQ5IDE1LjM2Myw1LjI2NiAxNS42NDgsNS4wODYgMTUuOTMsNC45MSAxNi4yMTUsNC43MzggMTYuNTA0LDQuNTY2IDE2Ljc5Myw0LjQwMiAxNy4wODIsNC4yMzQgMTcuMzc1LDQuMDc0IDE3LjY2OCwzLjkxOCAxNy45NjUsMy43NjIgMTguMjYyLDMuNjA5IDE4LjU1OSwzLjQ2MSAxOC44NTksMy4zMTIgMTkuMTYsMy4xNjggMTkuNDY1LDMuMDI3IDE5Ljc3LDIuODkxIDIwLjM3OSwyLjYyNSAyMC42ODQsMi41IDIxLjMwMSwyLjI1IDIxLjkyNiwyLjAxNiAyMi4yMzgsMS45MDIgMjIuODcxLDEuNjg0IDIzLjE4OCwxLjU4MiAyMy41MDgsMS40OCAyMy44MjQsMS4zODMgMjQuMTQ1LDEuMjg5IDI0LjQ2OSwxLjE5OSAyNC43ODksMS4xMDkgMjUuNDM4LDAuOTQ1IDI1Ljc2MiwwLjg2NyAyNi4wODYsMC43OTMgMjYuNDE0LDAuNzIzIDI2Ljc0MiwwLjY1NiAyNy4wNjYsMC41OSAyNy4zOTUsMC41MzEgMjcuNzI3LDAuNDczIDI4LjA1NSwwLjQxOCAyOC4zODMsMC4zNjcgMjkuMDQ3LDAuMjczIDI5LjM3OSwwLjIzNCAyOS43MDcsMC4xOTUgMzAuMDM5LDAuMTYgMzAuMzc1LDAuMTMzIDMwLjcwNywwLjEwMiAzMS4wMzksMC4wNzggMzEuNzAzLDAuMDM5IDMyLjAzOSwwLjAyNyAzMi4zNzEsMC4wMTYgMzIuNzAzLDAuMDA4IDMzLjAzOSwwIGggMC42NiBsIDAuMzMyLDAuMDA4IDAuMzM2LDAuMDA4IDAuMzMyLDAuMDA3IDAuMzMyLDAuMDE2IDAuMzM2LDAuMDIgMC4zMzIsMC4wMTkgMC4zMzIsMC4wMjQgMC4zMzIsMC4wMjcgMC4zMzIsMC4wMzEgMC42NjQsMC4wNyAwLjY2NCwwLjA4NiAwLjMyOSwwLjA0NyAwLjMzMiwwLjA1MSAwLjMyOCwwLjA1NSAwLjMyOCwwLjA1OCAwLjY1NiwwLjEyNSAwLjMyOCwwLjA2NyAwLjMyNCwwLjA3IDAuMzI5LDAuMDc0IDAuMzI0LDAuMDc4IDAuMzI0LDAuMDgyIDAuMzI0LDAuMDg2IDAuMzIxLDAuMDg2IDAuMzIsMC4wOSAwLjMyLDAuMDk0IDAuMzIsMC4wOTggMC4zMjEsMC4xMDEgMC4zMTYsMC4xMDIgMC42MzMsMC4yMTggMC4zMTIsMC4xMTQgMC42MjYsMC4yMzQgMC4zMDgsMC4xMjEgMC4zMDksMC4xMjkgMC4zMDgsMC4xMjUgMC4xOCwwLjA3OCAwLjMwMSwwLjEzMyAwLjYwOSwwLjI3MyAwLjYwMiwwLjI5IDAuMywwLjE0OCAwLjI5NywwLjE0OCAwLjI5NywwLjE1NyAwLjI5MywwLjE1NiAwLjI5MywwLjE2IDAuMjkzLDAuMTY0IDAuMjg5LDAuMTY0IDAuMjg5LDAuMTY4IDAuMjg1LDAuMTcyIDAuMjg2LDAuMTc2IDAuMjgxLDAuMTc2IDAuMjgxLDAuMTc5IDAuMjgxLDAuMTg0IDAuMjc4LDAuMTg3IDAuMjczLDAuMTg4IDAuMjc0LDAuMTkxIDAuMjczLDAuMTk2IDAuMjcsMC4xOTkgMC4yNjUsMC4xOTkgMC4yNjYsMC4yMDMgMC4yNjEsMC4yMDMgMC4yNjIsMC4yMDcgMC4yNjIsMC4yMTEgMC4yNTQsMC4yMTUgMC4yNTgsMC4yMTUgMC41LDAuNDM3IDAuMjUsMC4yMjMgMC4yNDYsMC4yMjcgMC4yNDIsMC4yMjYgMC4yNDIsMC4yMzEgMC40NzcsMC40NjggMC4xMzYsMC4xMzcgMC4yMzEsMC4yMzUgMC40NjEsMC40ODQgMC4yMjYsMC4yNDYgMC4yMjMsMC4yNDYgMC4yMjMsMC4yNSAwLjIxOCwwLjI1IDAuMjE1LDAuMjU0IDAuMjE1LDAuMjU4IDAuMjExLDAuMjU4IDAuMjExLDAuMjYxIDAuMjA3LDAuMjYyIDAuMjAzLDAuMjYyIDAuMTk5LDAuMjY5IDAuMiwwLjI2NiAwLjE5NSwwLjI3MyAwLjE5NSwwLjI3IDAuMTg4LDAuMjc3IDAuMTg3LDAuMjc0IDAuMTg4LDAuMjgxIDAuMTc5LDAuMjc3IDAuMTgsMC4yODUgMC4xNzYsMC4yODIgMC4xNzIsMC4yODUgMC4xNzIsMC4yODkgMC4xNjgsMC4yODkgMC4xNjQsMC4yODkgMC4xNiwwLjI5MyAwLjE1NiwwLjI5MyAwLjE1NiwwLjI5NyAwLjE1MywwLjI5NyAwLjE0OCwwLjI5NyAwLjE0OSwwLjMgMC4xNDQsMC4zMDEgMC4xNDEsMC4zMDUgMC4xMzYsMC4zMDUgMC4yNjYsMC42MDkgMC4xMjUsMC4zMDUgMC4yNSwwLjYxNyAwLjIzNCwwLjYyNSAwLjExNCwwLjMxMiAwLjIxOCwwLjYzMyAwLjEwMiwwLjMxNyAwLjEwMiwwLjMyIDAuMDk3LDAuMzE2IDAuMDk0LDAuMzIxIDAuMDksMC4zMjQgMC4wOSwwLjMyIDAuMTY0LDAuNjQ5IDAuMDc4LDAuMzI0IDAuMDc0LDAuMzI0IDAuMDcsMC4zMjggMC4wNjcsMC4zMjggMC4wNjYsMC4zMjQgMC4wNTksMC4zMjkgMC4wNTgsMC4zMzIgMC4wNTUsMC4zMjggMC4wNTEsMC4zMjggMC4wOTQsMC42NjQgMC4wMzksMC4zMzIgMC4wMzksMC4zMjggMC4wMzUsMC4zMzIgMC4wMzEsMC4zMzYgMC4wMjcsMC4zMzIgMC4wMjQsMC4zMzIgMC4wMzksMC42NjQgMC4wMTYsMC4zMzYgMC4wMTUsMC42NjQgMC4wMDgsMC4zMzYgdiAwLjY2IHogTSA2NS4xODQsMzMuMDU5IDY1LjE4LDMyLjc0MiA2NS4xNzIsMzIuNDIyIDY1LjE0OCwzMS43ODkgNjUuMTI5LDMxLjQ2OSA2NS4xMDksMzEuMTUyIDY1LjA4NiwzMC44MzYgNjUuMDMxLDMwLjIwMyA2NSwyOS44ODcgNjQuODgzLDI4LjkzOCA2NC44MzYsMjguNjI1IDY0Ljc4OSwyOC4zMDkgNjQuNjI1LDI3LjM3MSA2NC41NjIsMjcuMDU5IDY0LjQ5NiwyNi43NDYgNjQuNDMsMjYuNDM4IDY0LjM1OSwyNi4xMjUgNjQuMjg1LDI1LjgxNiA2NC4xMjksMjUuMTk5IDY0LjA0NywyNC44OTUgNjMuOTU3LDI0LjU4NiA2My43NzcsMjMuOTc3IDYzLjY4LDIzLjY3NiA2My41ODIsMjMuMzcxIDYzLjQ4LDIzLjA3IDYzLjM3NSwyMi43NyA2My4yNjYsMjIuNDczIDYzLjE1NiwyMi4xNzIgNjMuMDQzLDIxLjg3NSA2Mi45MjYsMjEuNTgyIDYyLjgwNSwyMS4yODUgNjIuNjg0LDIwLjk5NiA2Mi41NTksMjAuNzAzIDYyLjQzNCwyMC40MTQgNjIuMzAxLDIwLjEyMSA2Mi4xNjgsMTkuODMyIDYyLjAzMSwxOS41NDcgNjEuNzUsMTguOTc3IDYxLjYwMiwxOC42OTEgNjEuNDU3LDE4LjQxIDYxLjMwNSwxOC4xMzMgNjEuMTUyLDE3Ljg1MiA2MC45OTYsMTcuNTc4IDYwLjgzNiwxNy4zMDEgNjAuNTA4LDE2Ljc1NCA2MC4xNzIsMTYuMjE1IDU5Ljk5NiwxNS45NDkgNTkuODI0LDE1LjY4NCA1OS40NjUsMTUuMTYgNTkuMjgxLDE0LjkwMiA1OS4wOTQsMTQuNjQ1IDU4LjkwMiwxNC4zODcgNTguNzExLDE0LjEzMyA1OC41MiwxMy44ODMgNTguMTIxLDEzLjM4MyA1Ny45MjIsMTMuMTM3IDU3LjcxOSwxMi44OTUgNTcuNTEyLDEyLjY1MiA1Ny4zMDEsMTIuNDEgNTcuMDksMTIuMTcyIDU2LjY2LDExLjcwMyA1Ni4yMjMsMTEuMjQyIDU2LDExLjAxMiA1NS44NzEsMTAuODg3IDU1LjY0NSwxMC42NiA1NS40MTgsMTAuNDM4IDU1LjE4NCwxMC4yMTkgNTQuOTUzLDEwLjAwNCA1NC43MTksOS43ODkgNTQuNDgsOS41NzQgNTQuMjQyLDkuMzYzIDU0LjAwNCw5LjE1NiA1My43NTgsOC45NDkgNTMuNTE2LDguNzQ2IDUzLjI3LDguNTQ3IDUzLjAyLDguMzQ4IDUyLjc3LDguMTUyIDUyLjI2Miw3Ljc3IDUyLjAwNCw3LjU4MiA1MS43NDYsNy4zOTggNTEuNDg0LDcuMjE1IDUwLjk2MSw2Ljg1NSA1MC42OTUsNi42ODQgNTAuMTU2LDYuMzQgNDkuODg3LDYuMTc2IDQ5LjYxMyw2LjAxMiA0OS4zNCw1Ljg1MiA0OS4wNjIsNS42OTEgNDguNTA4LDUuMzg3IDQ4LjIyNyw1LjIzNCA0Ny45NDUsNS4wOSA0Ny42Niw0Ljk0NSA0Ny4wOSw0LjY2NCA0Ni41MTIsNC4zOTggNDYuMjE5LDQuMjY2IDQ1LjkyNiw0LjE0MSA0NS43NjIsNC4wNjYgNDUuNDY5LDMuOTQ1IDQ1LjE3MiwzLjgyNCA0NC44NzUsMy43MTEgNDQuNTc4LDMuNTk0IDQ0LjI4MSwzLjQ4NCA0My45OCwzLjM3NSA0My42ODQsMy4yNzMgNDMuMzc5LDMuMTY4IDQzLjA3OCwzLjA3IDQyLjc3MywyLjk3NyA0Mi40NzMsMi44ODMgNDIuMTY0LDIuNzkzIDQxLjU1NSwyLjYyMSA0MC45MzgsMi40NjUgNDAuNjI5LDIuMzkxIDQwLjMxNiwyLjMyIDQwLjAwOCwyLjI1NCAzOS42OTUsMi4xODggMzkuMDcsMi4wNyAzOC43NTgsMi4wMTYgMzguNDQ1LDEuOTY1IDM4LjEyOSwxLjkxNCAzNy44MTYsMS44NzEgMzcuNSwxLjgyOCAzNy4xODQsMS43ODkgMzYuNTUxLDEuNzE5IDM1LjkxOCwxLjY2NCAzNS42MDIsMS42NDEgMzUuMjgxLDEuNjIxIDM0LjY0OCwxLjU5IDM0LjMyOCwxLjU3OCAzNC4wMTIsMS41NyAzMy42OTEsMS41NjYgSCAzMy4wNjIgTCAzMi43NDIsMS41NyAzMi40MjYsMS41NzggMzIuMTA1LDEuNTkgMzEuNzg5LDEuNjA1IDMxLjQ2OSwxLjYyMSAzMS4xNTIsMS42NDEgMzAuODM2LDEuNjY0IDMwLjIwMywxLjcxOSAyOS41NywxLjc4OSAyOC45MzgsMS44NjcgMjguNjI1LDEuOTE0IDI4LjMwOSwxLjk2MSAyNy42ODQsMi4wNyAyNy4wNTksMi4xODggMjYuNzQ2LDIuMjU0IDI2LjQzOCwyLjMyIDI2LjEyNSwyLjM5MSAyNS44MTYsMi40NjUgMjUuMTk5LDIuNjIxIDI0Ljg5NSwyLjcwNyAyNC41ODYsMi43OTMgMjMuOTc3LDIuOTczIDIzLjY3NiwzLjA3IDIzLjM3MSwzLjE2OCAyMy4wNywzLjI3IDIyLjc3LDMuMzc1IDIyLjQ3MywzLjQ4NCAyMi4xNzIsMy41OTQgMjEuODc1LDMuNzA3IDIxLjU4MiwzLjgyNCAyMS4yODUsMy45NDUgMjAuOTk2LDQuMDY2IDIwLjcwMyw0LjE5MSAyMC40MTQsNC4zMiAyMC4xMjEsNC40NDkgMTkuODM2LDQuNTgyIDE5LjU0Nyw0LjcxOSAxOS4yNjIsNC44NTkgMTguNjkxLDUuMTQ4IDE4LjQxLDUuMjk3IDE4LjEzMyw1LjQ0NSAxNy44NTIsNS42MDIgMTcuNTc4LDUuNzU4IDE3LjMwMSw1LjkxNCAxNi43NTQsNi4yNDIgMTYuMjE1LDYuNTc4IDE1LjY4NCw2LjkzIDE1LjQyMiw3LjEwNSAxNS4xNiw3LjI4OSBsIC0wLjUxNSwwLjM2NyAtMC4yNTgsMC4xOTIgLTAuMjU0LDAuMTkxIC0wLjI1LDAuMTkxIC0wLjUsMC4zOTkgLTAuMjQ2LDAuMTk5IC0wLjI0MiwwLjIwNyAtMC4yNDMsMC4yMDMgLTAuMjQyLDAuMjExIC0wLjIzOCwwLjIxMSAtMC40NjksMC40MyAtMC40NjEsMC40MzcgLTAuMjI2LDAuMjI3IC0wLjEyOSwwLjEyNSAtMC4yMjcsMC4yMjYgLTAuMjE5LDAuMjMxIC0wLjIyMiwwLjIzIC0wLjIxNSwwLjIzMSBMIDkuNzg5LDEyLjAzMSA5LjU3NCwxMi4yNyA5LjM2MywxMi41MDggOC45NDksMTIuOTkyIDguNzQ2LDEzLjIzNCA4LjU0NywxMy40ODQgOC4zNDgsMTMuNzMgOC4xNTIsMTMuOTggNy43NywxNC40ODggNy41ODIsMTQuNzQ2IDcuMzk4LDE1LjAwNCA3LjIxNSwxNS4yNjYgNi44NTUsMTUuNzg5IDYuNjg0LDE2LjA1OSA2LjUxMiwxNi4zMjQgNi4xNzYsMTYuODYzIDYuMDEyLDE3LjEzNyA1Ljg1MiwxNy40MSA1LjY5MSwxNy42ODggNS4zODcsMTguMjQyIDUuMjM0LDE4LjUyMyA1LjA5LDE4LjgwOSA0Ljk0NSwxOS4wOSA0LjY2NCwxOS42NiA0LjM5OCwyMC4yMzggNC4yNjYsMjAuNTMxIDQuMTQxLDIwLjgyNCA0LjA2NiwyMC45ODggMy45NDUsMjEuMjgxIDMuODI0LDIxLjU3OCAzLjcxMSwyMS44NzUgMy41OTQsMjIuMTcyIDMuNDg0LDIyLjQ2OSAzLjM3NSwyMi43NyAzLjI3MywyMy4wNyAzLjE2OCwyMy4zNzEgMy4wNywyMy42NzIgMi44ODMsMjQuMjgxIDIuNzkzLDI0LjU4NiAyLjcwNywyNC44OTEgMi42MjEsMjUuMTk5IDIuNTQzLDI1LjUwNCAyLjQ2NSwyNS44MTIgMi4zOTEsMjYuMTIxIDIuMzIsMjYuNDM0IDIuMjU0LDI2Ljc0MiAyLjE4OCwyNy4wNTUgMi4wNywyNy42OCAyLjAxNiwyNy45OTIgMS45NjUsMjguMzA1IDEuOTE0LDI4LjYyMSAxLjg3MSwyOC45MzQgMS44MjgsMjkuMjUgMS43ODksMjkuNTY2IDEuNzE5LDMwLjE5OSAxLjY2NCwzMC44MzIgMS42NDEsMzEuMTQ4IDEuNjIxLDMxLjQ2OSAxLjU5LDMyLjEwMiAxLjU3OCwzMi40MjIgMS41NywzMi43MzggMS41NjYsMzMuMDU5IHYgMC42MzIgbCAwLjAwNCwwLjMxNyAwLjAwOCwwLjMyIDAuMDEyLDAuMzE3IDAuMDE1LDAuMzE2IDAuMDE2LDAuMzIgMC4wMiwwLjMxNyAwLjAyMywwLjMxNiAwLjAyNywwLjMxNiAwLjAyOCwwLjMyMSAwLjAzNSwwLjMxNiAwLjAzNSwwLjMxMyAwLjA3OCwwLjYzMiAwLjA0NywwLjMxNyAwLjA0NywwLjMxMiAwLjEwOSwwLjYyNSAwLjExOCwwLjYyNSAwLjEzMiwwLjYyNSAwLjA3MSwwLjMwOSAwLjA3NCwwLjMwOSAwLjE1NiwwLjYxNyAwLjA4NiwwLjMwNCAwLjA4NiwwLjMwOSAwLjE4LDAuNjA5IDAuMDk3LDAuMzAxIDAuMDk4LDAuMzA1IDAuMTAyLDAuMzAxIDAuMTA1LDAuMyAwLjEwOSwwLjI5NyAwLjExLDAuMzAxIDAuMTEzLDAuMjk3IDAuMTE3LDAuMjkzIDAuMTIxLDAuMjk3IDAuMTIxLDAuMjg5IDAuMTI1LDAuMjkzIDAuMTI5LDAuMjg5IDAuMTI5LDAuMjkzIDAuMTMzLDAuMjg5IDAuMTM3LDAuMjg1IDAuMTQsMC4yODUgMC4yODksMC41NzEgMC4xNDksMC4yODEgMC4xNDgsMC4yNzcgMC4xNTcsMC4yODEgMC4xNTYsMC4yNzggMC4xNTYsMC4yNzMgMC4zMjgsMC41NDcgMC4zMzYsMC41MzkgMC4zNTIsMC41MzEgMC4xNzUsMC4yNjIgMC4zNjgsMC41MjQgMC4xODMsMC4yNTcgMC41NzQsMC43NjIgMC4yLDAuMjUgMC4zOTgsMC40OTIgMC4yMDcsMC4yNDIgMC4yMDMsMC4yNDMgMC4yMTEsMC4yNDIgMC4yMTEsMC4yMzggMC40MywwLjQ2OSAwLjQzNywwLjQ2MSAwLjIyNywwLjIzIDAuMzUxLDAuMzUyIDAuMjMxLDAuMjIyIDAuMjMsMC4yMTkgMC4yMzEsMC4yMTUgMC4yMzQsMC4yMTkgMC40NzcsMC40MjIgMC40ODQsMC40MTQgMC4yNDIsMC4yMDMgMC4yNSwwLjE5OSAwLjI0NiwwLjE5OSAwLjI1LDAuMTk2IDAuNTA4LDAuMzgyIDAuMjU4LDAuMTg4IDAuMjU4LDAuMTg0IDAuMjYyLDAuMTgzIDAuMjYxLDAuMTggMC4yNjYsMC4xOCAwLjUzMSwwLjM0MyAwLjI3LDAuMTcyIDAuMjY5LDAuMTY0IDAuMjc0LDAuMTY0IDAuMjczLDAuMTYgMC4yNzgsMC4xNjEgMC4yNzcsMC4xNTIgMC4yODEsMC4xNTYgMC4yNzcsMC4xNDkgMC4yODYsMC4xNDQgMC4yODEsMC4xNDUgMC4yODUsMC4xNCAwLjI4OSwwLjE0MSAwLjI4NSwwLjEzNyAwLjI4OSwwLjEzMiAwLjU4NiwwLjI1OCAwLjE2NCwwLjA3MSAwLjI5NywwLjEyMSAwLjI5MywwLjEyMSAwLjI5NywwLjExNyAwLjI5NywwLjExMyAwLjI5NywwLjExIDAuMzAxLDAuMTA5IDAuMywwLjEwNSAwLjMwMSwwLjEwMiAwLjMwMSwwLjA5OCAwLjYwOSwwLjE4NyAwLjMwNSwwLjA5IDAuMzA1LDAuMDg2IDAuMzA4LDAuMDg2IDAuMzA1LDAuMDc4IDAuMzA4LDAuMDc4IDAuMzA5LDAuMDc0IDAuMzEzLDAuMDcxIDAuMzA4LDAuMDY2IDAuMzEzLDAuMDY2IDAuNjI1LDAuMTE4IDAuNjI1LDAuMTA5IDAuMzE2LDAuMDQ3IDAuMzEzLDAuMDQ3IDAuNjMyLDAuMDc4IDAuNjMzLDAuMDcgMC42MzMsMC4wNTUgMC4zMTYsMC4wMjMgMC4zMjEsMC4wMiAwLjYzMywwLjAzMSAwLjMyLDAuMDEyIDAuMzE2LDAuMDA4IDAuMzIxLDAuMDA0IGggMC42MzIgbCAwLjMxNywtMC4wMDQgMC4zMiwtMC4wMDggMC4zMTcsLTAuMDEyIDAuMzE2LC0wLjAxNSAwLjMyLC0wLjAxNiAwLjMxNywtMC4wMiAwLjMxNiwtMC4wMjMgMC4zMTYsLTAuMDI3IDAuMzIxLC0wLjAyOCAwLjMxNiwtMC4wMzEgMC4zMTMsLTAuMDM5IDAuNjMyLC0wLjA3OCAwLjMxNywtMC4wNDcgMC4zMTIsLTAuMDQ3IDAuOTM4LC0wLjE2NCAwLjMxMiwtMC4wNjMgMC42MjUsLTAuMTMyIDAuMzA5LC0wLjA3MSAwLjMwOSwtMC4wNzQgMC42MTcsLTAuMTU2IDAuMzA0LC0wLjA4MiAwLjMwOSwtMC4wOSAwLjYwOSwtMC4xOCAwLjMwMSwtMC4wOTcgMC4zMDUsLTAuMDk4IDAuMzAxLC0wLjEwMiAwLjMsLTAuMTA1IDAuMjk3LC0wLjEwOSAwLjMwMSwtMC4xMSAwLjI5NywtMC4xMTMgMC4yOTcsLTAuMTE3IDAuMjkzLC0wLjEyMSAwLjI4OSwtMC4xMjEgMC41ODYsLTAuMjUgMC41NzgsLTAuMjY2IDAuMjg1LC0wLjEzNyAwLjU3LC0wLjI4MSAwLjI4NiwtMC4xNDggMC4yODEsLTAuMTQ5IDAuMjc3LC0wLjE0OCAwLjI4MSwtMC4xNTMgMC4yNzgsLTAuMTU2IDAuMjczLC0wLjE2IDAuNTQ3LC0wLjMyOCAwLjUzOSwtMC4zMzYgMC4yNjYsLTAuMTc2IDAuMjY1LC0wLjE3MiAwLjUyNCwtMC4zNTkgMC4yNjIsLTAuMTg4IDAuMjU3LC0wLjE4MyAwLjc2MiwtMC41NzQgMC4yNSwtMC4yIDAuNDkyLC0wLjM5OCAwLjI0NiwtMC4yMDMgMC4yMzksLTAuMjA3IDAuMjQyLC0wLjIxMSAwLjIzOCwtMC4yMTEgMC40NjksLTAuNDMgMC40NjEsLTAuNDM3IDAuMjMsLTAuMjI3IDAuMzUyLC0wLjM1MSAwLjIyMiwtMC4yMzEgMC40MzgsLTAuNDYxIDAuMjE1LC0wLjIzNCAwLjQyMiwtMC40NzcgMC4yMDcsLTAuMjM4IDAuMjA3LC0wLjI0NiAwLjIwMywtMC4yNDIgMC4xOTksLTAuMjQ2IDAuMTk5LC0wLjI1IDAuMTk2LC0wLjI1IDAuMzgyLC0wLjUwOCAwLjE4OCwtMC4yNTggMC4xODQsLTAuMjU4IDAuMTgzLC0wLjI2MiAwLjM2LC0wLjUyMyAwLjE3MSwtMC4yNjYgMC4zNDQsLTAuNTM5IDAuMTY0LC0wLjI2OSAwLjE2NCwtMC4yNzQgMC4xNiwtMC4yNzMgMC4xNjEsLTAuMjc4IDAuMTUyLC0wLjI3NyAwLjE1NiwtMC4yNzcgMC4xNDksLTAuMjgxIDAuMTQ0LC0wLjI4MiAwLjE0NSwtMC4yODUgMC4yODEsLTAuNTcgMC4xMzcsLTAuMjg5IDAuMTMyLC0wLjI4OSAwLjI1OCwtMC41ODYgMC4wNzEsLTAuMTY0IDAuMTIxLC0wLjI5MyAwLjEyMSwtMC4yOTcgMC4xMTcsLTAuMjk3IDAuMTEzLC0wLjI5NyAwLjExLC0wLjI5NyAwLjEwOSwtMC4zMDEgMC4xMDUsLTAuMjk2IDAuMTAyLC0wLjMwNSAwLjA5OCwtMC4zMDEgMC4wOTcsLTAuMzA1IDAuMDksLTAuMyAwLjA5LC0wLjMwOSAwLjE3MiwtMC42MDkgMC4xNTYsLTAuNjE3IDAuMDc0LC0wLjMwOSAwLjA3MSwtMC4zMTMgMC4wNjYsLTAuMzA4IDAuMDY2LC0wLjMxMyAwLjExOCwtMC42MjUgMC4xMDksLTAuNjI1IDAuMDQ3LC0wLjMxNiAwLjA0NywtMC4zMTMgMC4wNzgsLTAuNjMyIDAuMDcsLTAuNjMzIDAuMDU1LC0wLjYzMyAwLjAyMywtMC4zMTYgMC4wMiwtMC4zMjEgMC4wMzEsLTAuNjMzIDAuMDEyLC0wLjMyIDAuMDA4LC0wLjMxNiAwLjAwNCwtMC4zMjEgeiIKICAgICAgIHN0eWxlPSJmaWxsOiNjNGQ2MDA7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmUiCiAgICAgICBpZD0icGF0aDg1NCIgLz48L2c+PC9zdmc+Cg=="
        };
    }

    protected override void OnTargetFileStreamInitialized(Stream targetFileStream)
    {
        _htmlWriter = CreateMessagesToHtmlWriter(
            targetFileStream,
            async (sw, e) => await sw.WriteAsync(NdjsonSerializer.Serialize(e)));
    }

    protected override void OnTargetFileStreamDisposing()
    {
        _htmlWriter?.Dispose();
        _htmlWriter = null;
    }

    protected override async Task FlushTargetFileStream(CancellationToken cancellationToken)
    {
        if (_htmlWriter != null)
        {
            await _htmlWriter.DisposeAsync();
            _htmlWriter = null;
            // We should not call base.FlushTargetFileStream here because the HtmlWriter already disposed the stream
            // and the stream's flush operation would throw an exception.
        }
        else
        {
            await base.FlushTargetFileStream(cancellationToken);
        }
    }

    protected override async Task WriteToFile(Envelope envelope, CancellationToken cancellationToken)
    {
        if (_htmlWriter != null)
        {
            await _htmlWriter.WriteAsync(envelope);
        }
    }
}