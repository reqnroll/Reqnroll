#nullable enable

using Cucumber.HtmlFormatter;
using Io.Cucumber.Messages.Types;
using Reqnroll.Formatters.Configuration;
using Reqnroll.Formatters.PayloadProcessing;
using Reqnroll.Formatters.RuntimeSupport;
using Reqnroll.Utils;
using System;
using System.IO;
using System.Threading;
using System.Threading.Tasks;

namespace Reqnroll.Formatters.Html;

/// <summary>
/// Produces an HTML report file based on https://github.com/cucumber/html-formatter/ and https://github.com/cucumber/react-components.
/// </summary>
public class HtmlFormatter : FileWritingFormatterBase
{
    private MessagesToHtmlWriter? _htmlWriter;

    protected HtmlFormatter(IFormattersConfigurationProvider configurationProvider, IFormatterLog logger, IFileSystem fileSystem, string pluginName) : 
        base(configurationProvider, logger, fileSystem, pluginName, ".html", "reqnroll_report.html")
    {
    }

    public HtmlFormatter(IFormattersConfigurationProvider configurationProvider, IFormatterLog logger, IFileSystem fileSystem) : 
        this(configurationProvider, logger, fileSystem, "html")
    {
    }

    protected virtual MessagesToHtmlWriter CreateMessagesToHtmlWriter(Stream stream, Func<StreamWriter, Envelope, Task> asyncStreamSerializer) 
        => new(stream, asyncStreamSerializer, GetHtmlReportSettings());

    protected virtual HtmlReportSettings GetHtmlReportSettings()
    {
        return new HtmlReportSettings
        {
            Title = $"Reqnroll Report {DateTime.Now:u}",
            Icon = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIgogICB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgdmVyc2lvbj0iMS4xIgogICBpZD0ic3ZnODQyIgogICB4bWw6c3BhY2U9InByZXNlcnZlIgogICB3aWR0aD0iOTkiCiAgIGhlaWdodD0iOTkiCiAgIHZpZXdCb3g9IjAgMCA5OSA5OSIKICAgc29kaXBvZGk6ZG9jbmFtZT0icmVxbnJvbGwtaWNvbi5zdmciCiAgIGlua3NjYXBlOnZlcnNpb249IjEuMC4yLTIgKGU4NmM4NzA4NzksIDIwMjEtMDEtMTUpIgogICBpbmtzY2FwZTpleHBvcnQtZmlsZW5hbWU9IkM6XFVzZXJzXGdhc3BhclxEcm9wYm94XFNwZWNTb2xcUmVxbnJvbGxcTG9nb1xpY29uXHJlcW5yb2xsLWljb24tNTEyeDUxMi5wbmciCiAgIGlua3NjYXBlOmV4cG9ydC14ZHBpPSI0OTYuNDgwMDEiCiAgIGlua3NjYXBlOmV4cG9ydC15ZHBpPSI0OTYuNDgwMDEiPjxtZXRhZGF0YQogICAgIGlkPSJtZXRhZGF0YTg0OCI+PHJkZjpSREY+PGNjOldvcmsKICAgICAgICAgcmRmOmFib3V0PSIiPjxkYzpmb3JtYXQ+aW1hZ2Uvc3ZnK3htbDwvZGM6Zm9ybWF0PjxkYzp0eXBlCiAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vcHVybC5vcmcvZGMvZGNtaXR5cGUvU3RpbGxJbWFnZSIgLz48ZGM6dGl0bGUgLz48L2NjOldvcms+PC9yZGY6UkRGPjwvbWV0YWRhdGE+PGRlZnMKICAgICBpZD0iZGVmczg0NiIgLz48c29kaXBvZGk6bmFtZWR2aWV3CiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjNjY2NjY2IgogICAgIGJvcmRlcm9wYWNpdHk9IjEiCiAgICAgb2JqZWN0dG9sZXJhbmNlPSIxMCIKICAgICBncmlkdG9sZXJhbmNlPSIxMCIKICAgICBndWlkZXRvbGVyYW5jZT0iMTAiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAiCiAgICAgaW5rc2NhcGU6cGFnZXNoYWRvdz0iMiIKICAgICBpbmtzY2FwZTp3aW5kb3ctd2lkdGg9IjE5MjAiCiAgICAgaW5rc2NhcGU6d2luZG93LWhlaWdodD0iMTAxNyIKICAgICBpZD0ibmFtZWR2aWV3ODQ0IgogICAgIHNob3dncmlkPSJmYWxzZSIKICAgICBpbmtzY2FwZTp6b29tPSI0LjY0NjA1NTEiCiAgICAgaW5rc2NhcGU6Y3g9IjMzLjQzOTc0NiIKICAgICBpbmtzY2FwZTpjeT0iNDMuOTI2ODgyIgogICAgIGlua3NjYXBlOndpbmRvdy14PSItOCIKICAgICBpbmtzY2FwZTp3aW5kb3cteT0iMTA3MiIKICAgICBpbmtzY2FwZTp3aW5kb3ctbWF4aW1pemVkPSIxIgogICAgIGlua3NjYXBlOmN1cnJlbnQtbGF5ZXI9ImxheWVyMiIKICAgICBpbmtzY2FwZTpkb2N1bWVudC1yb3RhdGlvbj0iMCIKICAgICBzaG93Ym9yZGVyPSJ0cnVlIgogICAgIGZpdC1tYXJnaW4tdG9wPSI1IgogICAgIGZpdC1tYXJnaW4tbGVmdD0iNSIKICAgICBmaXQtbWFyZ2luLXJpZ2h0PSI1IgogICAgIGZpdC1tYXJnaW4tYm90dG9tPSI1IgogICAgIGxvY2stbWFyZ2lucz0idHJ1ZSIgLz48ZwogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaWQ9ImxheWVyMiIKICAgICBpbmtzY2FwZTpsYWJlbD0iYmxhY2siCiAgICAgc3R5bGU9ImRpc3BsYXk6bm9uZSIKICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1LDUpIj48Y2lyY2xlCiAgICAgICBzdHlsZT0iZmlsbDojMTExMTFmO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDowLjU1NDE0OTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdG9wLWNvbG9yOiMwMDAwMDAiCiAgICAgICBpZD0iY2lyY2xlODY3IgogICAgICAgY3g9IjQ0LjUiCiAgICAgICBjeT0iNDQuNSIKICAgICAgIGlua3NjYXBlOmxhYmVsPSJibGFja19jaXJjbCIKICAgICAgIHI9IjQ0IiAvPjwvZz48ZwogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaWQ9ImxheWVyMyIKICAgICBpbmtzY2FwZTpsYWJlbD0id2hpdGUiCiAgICAgc3R5bGU9ImRpc3BsYXk6aW5saW5lIgogICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDUsNSkiPjxjaXJjbGUKICAgICAgIHN0eWxlPSJkaXNwbGF5OmlubGluZTtmaWxsOiNmZmZmZmY7ZmlsbC1vcGFjaXR5OjE7c3Ryb2tlOm5vbmU7c3Ryb2tlLXdpZHRoOjAuNTU0MTQ5O3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0b3AtY29sb3I6IzAwMDAwMCIKICAgICAgIGlkPSJjaXJjbGU4NjMiCiAgICAgICBjeD0iNDQuNSIKICAgICAgIGN5PSI0NCIKICAgICAgIGlua3NjYXBlOmxhYmVsPSJ3aGl0ZV9jaXJjbGUiCiAgICAgICByPSI0NCIgLz48L2c+PGcKICAgICBpbmtzY2FwZTpncm91cG1vZGU9ImxheWVyIgogICAgIGlkPSJsYXllcjEiCiAgICAgaW5rc2NhcGU6bGFiZWw9ImRhcmsiCiAgICAgc3R5bGU9ImRpc3BsYXk6bm9uZSIKICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1LDUpIj48Y2lyY2xlCiAgICAgICBzdHlsZT0iZGlzcGxheTppbmxpbmU7ZmlsbDojM2I0MDAwO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDowLjU1NDE0OTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdG9wLWNvbG9yOiMwMDAwMDAiCiAgICAgICBpZD0icGF0aDg1NiIKICAgICAgIGN4PSI0NC41IgogICAgICAgY3k9IjQ0LjUiCiAgICAgICBpbmtzY2FwZTpsYWJlbD0iZGFya19jaXJjbGUiCiAgICAgICByPSI0NCIgLz48L2c+PGcKICAgICBpZD0iZzg1MCIKICAgICBpbmtzY2FwZTpsYWJlbD0iY3VzdG9tY29sb3JfaWNvbl90cmFuc3BhcmVudF9iYWNrZ3JvdW5kIgogICAgIHRyYW5zZm9ybT0ibWF0cml4KDEuMzMzMzMzMywwLDAsMS4zMzMzMzMzLDUsNS4wMDAwMDE5KSIKICAgICBzb2RpcG9kaTppbnNlbnNpdGl2ZT0idHJ1ZSIKICAgICBzdHlsZT0iZGlzcGxheTppbmxpbmUiPjxnCiAgICAgICBpZD0iZzg1MiI+PHBhdGgKICAgICAgICAgZD0ibSAzLjcxOSwzMy4zNzUgYyAwLC0xNi4zNzkgMTMuMjc3LC0yOS42NTYgMjkuNjU2LC0yOS42NTYgMTYuMzc5LDAgMjkuNjU2LDEzLjI3NyAyOS42NTYsMjkuNjU2IDAsMTYuMzc5IC0xMy4yNzcsMjkuNjU2IC0yOS42NTYsMjkuNjU2IEMgMTYuOTk2LDYzLjAzMSAzLjcxOSw0OS43NTQgMy43MTksMzMuMzc1IFogTSA0Ni4wMDQsMjAuNDc3IFYgOS45NzcgTCA0My43ODUsOS44MDkgYyAtNC4wOTcsMCAtNy45MSwwLjk5NiAtMTEuNDM3LDIuOTg0IC0zLjY0NSwyLjA1MSAtNi41MDQsNC43OTcgLTguNTc4LDguMjM4IC0yLjA3OSwzLjQ0NiAtMy4xMTgsNy4xODQgLTMuMTE4LDExLjIyNyBsIDAuMDg2LDI0LjQ5NiBoIDkuOTg5IEwgMzAuNTU1LDMzLjc5MyBjIDAsLTIuNTA0IDAuNjI1LC00Ljc1IDEuODc5LC02Ljc0MiAxLjE5NSwtMi4wNTEgMi44MjgsLTMuNjg4IDQuOTA2LC00LjkxIDIuMDc4LC0xLjIyMyA0LjMxMiwtMS44MzYgNi42OTksLTEuODM2IDAuMjg1LDAgMC45NDEsMC4wNTggMS45NjUsMC4xNzIgeiBtIDIwLjczOCwxMy41NTQgLTAuMDA4LDAuMzM2IC0wLjAwNywwLjMzMiAtMC4wMTYsMC4zMzIgLTAuMDIsMC4zMzYgLTAuMDE5LDAuMzMyIC0wLjAyNCwwLjMzMiAtMC4wMjcsMC4zMzIgLTAuMDMxLDAuMzMyIC0wLjA3LDAuNjY0IC0wLjA4NiwwLjY2NCAtMC4wNDcsMC4zMjkgLTAuMDUxLDAuMzMyIC0wLjA1NSwwLjMyOCAtMC4xMTcsMC42NTYgLTAuMTMzLDAuNjU2IC0wLjA3LDAuMzI0IC0wLjA3NCwwLjMyOSAtMC4wNzgsMC4zMjQgLTAuMTY0LDAuNjQ4IC0wLjE4LDAuNjQxIC0wLjA5NCwwLjMyIC0wLjA5OCwwLjMyIC0wLjEwMSwwLjMyMSAtMC4xMDIsMC4zMTYgLTAuMjE4LDAuNjMzIC0wLjExNCwwLjMxMiAtMC4yMzQsMC42MjYgLTAuMTIxLDAuMzA4IC0wLjEyNSwwLjMwOSAtMC4xMjksMC4zMDggLTAuMDc4LDAuMTggLTAuMTMzLDAuMzAxIC0wLjEzMywwLjMwNCAtMC4xNCwwLjMwNSAtMC4xNDEsMC4zMDEgLTAuMTQ5LDAuMzAxIC0wLjE0NCwwLjMgLTAuMTUyLDAuMjk3IC0wLjE1NywwLjI5NyAtMC4xNTYsMC4yOTMgLTAuMzIsMC41ODYgLTAuMzM2LDAuNTc4IC0wLjE3MiwwLjI4NSAtMC4xNzYsMC4yODYgLTAuMTc2LDAuMjgxIC0wLjE3OSwwLjI4MSAtMC4xODQsMC4yODEgLTAuMTg3LDAuMjc4IC0wLjE4OCwwLjI3MyAtMC4xOTEsMC4yNzQgLTAuMTk2LDAuMjczIC0wLjE5OSwwLjI2NiAtMC4xOTksMC4yNjkgLTAuMjAzLDAuMjY2IC0wLjIwMywwLjI2MSAtMC4yMDcsMC4yNjIgLTAuMjExLDAuMjYyIC0wLjIxNSwwLjI1NCAtMC4yMTUsMC4yNTggLTAuNDM3LDAuNSAtMC4yMjMsMC4yNSAtMC4yMjcsMC4yNDYgLTAuMjI2LDAuMjQyIC0wLjIzMSwwLjI0MiAtMC40NjgsMC40NzcgLTAuMTM3LDAuMTM2IC0wLjIzNSwwLjIzMSAtMC40ODQsMC40NjEgLTAuMjQ2LDAuMjI2IC0wLjI0NiwwLjIyMyAtMC4yNSwwLjIyMyAtMC4yNSwwLjIxOCAtMC4yNTQsMC4yMTUgLTAuMjU4LDAuMjE1IC0wLjI1OCwwLjIxMSAtMC4yNjEsMC4yMTEgLTAuMjYyLDAuMjA3IC0wLjI2MiwwLjIwMyAtMC4yNjksMC4xOTkgLTAuMjY2LDAuMiAtMC4yNzMsMC4xOTUgLTAuMjcsMC4xOTUgLTAuMjc3LDAuMTg4IC0wLjI3NCwwLjE4NyAtMC4yODEsMC4xODggLTAuMjc3LDAuMTc5IC0wLjI4MiwwLjE4IC0wLjI4NSwwLjE3NiAtMC4yODUsMC4xNzIgLTAuMjg5LDAuMTcyIC0wLjI4OSwwLjE2OCAtMC4yODksMC4xNjQgLTAuMjkzLDAuMTYgLTAuMjkzLDAuMTU2IC0wLjI5NywwLjE1NiAtMC4yOTcsMC4xNTMgLTAuMjk3LDAuMTQ4IC0wLjMsMC4xNDkgLTAuMzAxLDAuMTQ0IC0wLjMwNSwwLjE0MSAtMC4zMDEsMC4xMzYgLTAuMzA4LDAuMTMzIC0wLjMwNSwwLjEzMyAtMC4zMDUsMC4xMjUgLTAuNjE3LDAuMjUgLTAuNjI1LDAuMjM0IC0wLjMxMiwwLjExNCAtMC42MzMsMC4yMTggLTAuMzE3LDAuMTAyIC0wLjMyLDAuMTAyIC0wLjMxNiwwLjA5NyAtMC4zMjEsMC4wOTQgLTAuMzI0LDAuMDkgLTAuMzIsMC4wOSAtMC42NDksMC4xNjQgLTAuMzI0LDAuMDc4IC0wLjMyNCwwLjA3NCAtMC4zMjgsMC4wNyAtMC4zMjQsMC4wNjcgLTAuMzI4LDAuMDY2IC0wLjMyOSwwLjA1OSAtMC4zMzIsMC4wNTggLTAuMzI4LDAuMDU1IC0wLjMyOCwwLjA1MSAtMC42NjQsMC4wOTQgLTAuMzI4LDAuMDM5IC0wLjMzMiwwLjAzOSAtMC4zMzIsMC4wMzUgLTAuMzMyLDAuMDMxIC0wLjMzNiwwLjAyNyAtMC4zMzIsMC4wMjQgLTAuNjY0LDAuMDM5IC0wLjMzNiwwLjAxNiAtMC42NjQsMC4wMTUgLTAuMzM2LDAuMDA4IGggLTAuNjYgTCAzMi43MTksNjYuNzQyIDMyLjM4Myw2Ni43MzQgMzIuMDUxLDY2LjcyNyAzMS43MTksNjYuNzExIDMxLjM4Myw2Ni42OTEgMzEuMDUxLDY2LjY3MiAzMC43MTksNjYuNjQ4IDMwLjM4Nyw2Ni42MjEgMzAuMDU1LDY2LjU5IDI5LjM5MSw2Ni41MiAyOC43MjcsNjYuNDM0IDI4LjM5OCw2Ni4zODcgMjguMDY2LDY2LjMzNiAyNy43MzgsNjYuMjgxIDI3LjA4Miw2Ni4xNjQgMjYuNDI2LDY2LjAzMSAyNi4xMDIsNjUuOTYxIDI1Ljc3Myw2NS44ODcgMjUuNDQ5LDY1LjgwOSAyNC44MDEsNjUuNjQ1IDI0LjE2LDY1LjQ2NSAyMy44NCw2NS4zNzEgMjMuNTIsNjUuMjczIDIzLjE5OSw2NS4xNzIgMjIuODgzLDY1LjA3IDIyLjU2Niw2NC45NjEgMjIuMjU0LDY0Ljg1MiAyMS45MzgsNjQuNzM4IDIxLjMxMiw2NC41MDQgMjEuMDA0LDY0LjM4MyAyMC42OTUsNjQuMjU4IDIwLjM4Nyw2NC4xMjkgMjAuMjExLDY0LjA1MSAxOS42MDIsNjMuNzg1IDE5LjI5Nyw2My42NDUgMTguOTk2LDYzLjUwNCAxOC4zOTUsNjMuMjA3IDE4LjA5OCw2My4wNTkgMTcuODAxLDYyLjkwMiAxNy41MDgsNjIuNzQ2IDE2LjkyMiw2Mi40MjYgMTYuMzQ0LDYyLjA5IDE2LjA1OSw2MS45MTggMTUuNzczLDYxLjc0MiAxNS40OTIsNjEuNTY2IDE1LjIxMSw2MS4zODcgMTQuOTMsNjEuMjAzIDE0LjY1Miw2MS4wMTYgMTQuMzc5LDYwLjgyOCAxNC4xMDUsNjAuNjM3IDEzLjgzNiw2MC40NDEgMTMuMjk3LDYwLjA0MyAxMy4wMzEsNTkuODQgMTIuNzcsNTkuNjM3IDEyLjUwOCw1OS40MyAxMi4yNSw1OS4yMTkgMTEuOTkyLDU5LjAwNCAxMS43MzgsNTguNzg5IDExLjQ4NCw1OC41NyAxMS4yMzQsNTguMzUyIDEwLjk4NCw1OC4xMjkgMTAuNzM4LDU3LjkwMiAxMC40OTYsNTcuNjc2IDEwLjI1NCw1Ny40NDUgOS43NzcsNTYuOTc3IDkuNjQxLDU2Ljg0IDkuNDEsNTYuNjA1IDguOTQ5LDU2LjEyMSA4LjcyMyw1NS44NzUgOC41LDU1LjYyOSA4LjI3Nyw1NS4zNzkgOC4wNTksNTUuMTI5IDcuODQ0LDU0Ljg3NSA3LjYyOSw1NC42MTcgNy40MTgsNTQuMzU5IDcuMjA3LDU0LjA5OCA3LDUzLjgzNiA2Ljc5Nyw1My41NzQgNi41OTgsNTMuMzA1IDYuMzk4LDUzLjAzOSA2LjIwMyw1Mi43NjYgNi4wMDgsNTIuNDk2IDUuODIsNTIuMjE5IDUuNjMzLDUxLjk0NSA1LjQ0OSw1MS42NjQgNS4yNjYsNTEuMzg3IDUuMDg2LDUxLjEwNSA0LjkxLDUwLjgyIDQuNzM4LDUwLjUzNSA0LjU2Niw1MC4yNDYgNC40MDIsNDkuOTU3IDQuMjM0LDQ5LjY2OCA0LjA3NCw0OS4zNzUgMy45MTgsNDkuMDgyIDMuNzYyLDQ4Ljc4NSAzLjYwOSw0OC40ODggMy40NjEsNDguMTkxIDMuMzEyLDQ3Ljg5MSAzLjE2OCw0Ny41OSAzLjAyNyw0Ny4yODUgMi44OTEsNDYuOTg0IDIuNzU4LDQ2LjY3NiAyLjYyNSw0Ni4zNzEgMi41LDQ2LjA2NiAyLjI1LDQ1LjQ0OSAyLjAxNiw0NC44MjQgMS45MDIsNDQuNTEyIDEuNjg0LDQzLjg3OSAxLjU4Miw0My41NjIgMS40OCw0My4yNDIgMS4zODMsNDIuOTI2IDEuMjg5LDQyLjYwNSAxLjE5OSw0Mi4yODEgMS4xMDksNDEuOTYxIDAuOTQ1LDQxLjMxMiAwLjg2Nyw0MC45ODggMC43OTMsNDAuNjY0IDAuNzIzLDQwLjMzNiAwLjY1Niw0MC4wMTIgMC41OSwzOS42ODQgMC41MzEsMzkuMzU1IDAuNDczLDM5LjAyMyAwLjQxOCwzOC42OTUgMC4zNjcsMzguMzY3IDAuMjczLDM3LjcwMyAwLjIzNCwzNy4zNzUgMC4xOTUsMzcuMDQzIDAuMTYsMzYuNzExIDAuMTMzLDM2LjM3OSAwLjEwMiwzNi4wNDMgMC4wNzgsMzUuNzExIDAuMDM5LDM1LjA0NyAwLjAyNywzNC43MTEgMC4wMTYsMzQuMzc5IDAuMDA4LDM0LjA0NyAwLDMzLjcxMSB2IC0wLjY2IGwgMC4wMDgsLTAuMzMyIDAuMDA4LC0wLjMzNiAwLjAwNywtMC4zMzIgMC4wMTYsLTAuMzMyIDAuMDIsLTAuMzM2IDAuMDE5LC0wLjMzMiAwLjAyNCwtMC4zMzIgMC4wMjcsLTAuMzMyIDAuMDMxLC0wLjMzMiAwLjA3LC0wLjY2NCAwLjA4NiwtMC42NjQgMC4wNDcsLTAuMzI5IDAuMDUxLC0wLjMzMiAwLjA1NSwtMC4zMjggMC4wNTgsLTAuMzI4IDAuMTI1LC0wLjY1NiAwLjA2NywtMC4zMjggMC4wNywtMC4zMjQgMC4wNzQsLTAuMzI5IDAuMDc4LC0wLjMyNCAwLjA4MiwtMC4zMjQgMC4wODYsLTAuMzI0IDAuMDg2LC0wLjMyMSAwLjA5LC0wLjMyIDAuMDk0LC0wLjMyIDAuMDk4LC0wLjMyIDAuMTAxLC0wLjMyMSAwLjEwMiwtMC4zMTYgMC4xMDksLTAuMzE3IDAuMTA5LC0wLjMxMiAwLjExNCwtMC4zMTYgMC4yMzQsLTAuNjI2IDAuMTIxLC0wLjMwOCAwLjEyOSwtMC4zMDkgMC4xMjUsLTAuMzA4IDAuMDc4LC0wLjE4IDAuMTMzLC0wLjMwMSAwLjI3MywtMC42MDkgMC4yOSwtMC42MDIgMC4xNDgsLTAuMyAwLjE0OCwtMC4yOTcgMC4xNTcsLTAuMjk3IDAuMTU2LC0wLjI5MyAwLjE2LC0wLjI5MyBMIDQuMzI4LDE2LjkyMiA0LjQ5MiwxNi42MzMgNC42NiwxNi4zNDQgNC44MzIsMTYuMDU5IDUuMDA4LDE1Ljc3MyA1LjE4NCwxNS40OTIgNS4zNjMsMTUuMjExIDUuNTQ3LDE0LjkzIDUuNzM0LDE0LjY1MiA1LjkyMiwxNC4zNzkgNi4xMTMsMTQuMTA1IDYuMzA5LDEzLjgzNiA2LjcwNywxMy4yOTcgNi45MSwxMy4wMzEgNy4xMTMsMTIuNzcgNy4zMiwxMi41MDggNy41MzEsMTIuMjUgNy43NDYsMTEuOTkyIDcuOTYxLDExLjczOCA4LjE4LDExLjQ4NCA4LjM5OCwxMS4yMzQgOC42MjEsMTAuOTg0IDguODQ4LDEwLjczOCA5LjA3NCwxMC40OTYgOS4zMDUsMTAuMjU0IDkuNzczLDkuNzc3IDkuOTEsOS42NDEgMTAuMTQ1LDkuNDEgMTAuNjI5LDguOTQ5IDEwLjg3NSw4LjcyMyAxMS4xMjEsOC41IDExLjM3MSw4LjI3NyAxMS42MjEsOC4wNTkgMTEuODc1LDcuODQ0IDEyLjEzMyw3LjYyOSAxMi4zOTEsNy40MTggMTIuNjUyLDcuMjA3IDEyLjkxNCw3IDEzLjE3Niw2Ljc5NyAxMy40NDUsNi41OTggMTMuNzExLDYuMzk4IDEzLjk4NCw2LjIwMyAxNC4yNTQsNi4wMDggMTQuNTMxLDUuODIgMTQuODA1LDUuNjMzIDE1LjA4Niw1LjQ0OSAxNS4zNjMsNS4yNjYgMTUuNjQ4LDUuMDg2IDE1LjkzLDQuOTEgMTYuMjE1LDQuNzM4IDE2LjUwNCw0LjU2NiAxNi43OTMsNC40MDIgMTcuMDgyLDQuMjM0IDE3LjM3NSw0LjA3NCAxNy42NjgsMy45MTggMTcuOTY1LDMuNzYyIDE4LjI2MiwzLjYwOSAxOC41NTksMy40NjEgMTguODU5LDMuMzEyIDE5LjE2LDMuMTY4IDE5LjQ2NSwzLjAyNyAxOS43NywyLjg5MSAyMC4zNzksMi42MjUgMjAuNjg0LDIuNSAyMS4zMDEsMi4yNSAyMS45MjYsMi4wMTYgMjIuMjM4LDEuOTAyIDIyLjg3MSwxLjY4NCAyMy4xODgsMS41ODIgMjMuNTA4LDEuNDggMjMuODI0LDEuMzgzIDI0LjE0NSwxLjI4OSAyNC40NjksMS4xOTkgMjQuNzg5LDEuMTA5IDI1LjQzOCwwLjk0NSAyNS43NjIsMC44NjcgMjYuMDg2LDAuNzkzIDI2LjQxNCwwLjcyMyAyNi43NDIsMC42NTYgMjcuMDY2LDAuNTkgMjcuMzk1LDAuNTMxIDI3LjcyNywwLjQ3MyAyOC4wNTUsMC40MTggMjguMzgzLDAuMzY3IDI5LjA0NywwLjI3MyAyOS4zNzksMC4yMzQgMjkuNzA3LDAuMTk1IDMwLjAzOSwwLjE2IDMwLjM3NSwwLjEzMyAzMC43MDcsMC4xMDIgMzEuMDM5LDAuMDc4IDMxLjcwMywwLjAzOSAzMi4wMzksMC4wMjcgMzIuMzcxLDAuMDE2IDMyLjcwMywwLjAwOCAzMy4wMzksMCBoIDAuNjYgbCAwLjMzMiwwLjAwOCAwLjMzNiwwLjAwOCAwLjMzMiwwLjAwNyAwLjMzMiwwLjAxNiAwLjMzNiwwLjAyIDAuMzMyLDAuMDE5IDAuMzMyLDAuMDI0IDAuMzMyLDAuMDI3IDAuMzMyLDAuMDMxIDAuNjY0LDAuMDcgMC42NjQsMC4wODYgMC4zMjksMC4wNDcgMC4zMzIsMC4wNTEgMC4zMjgsMC4wNTUgMC4zMjgsMC4wNTggMC42NTYsMC4xMjUgMC4zMjgsMC4wNjcgMC4zMjQsMC4wNyAwLjMyOSwwLjA3NCAwLjMyNCwwLjA3OCAwLjMyNCwwLjA4MiAwLjMyNCwwLjA4NiAwLjMyMSwwLjA4NiAwLjMyLDAuMDkgMC4zMiwwLjA5NCAwLjMyLDAuMDk4IDAuMzIxLDAuMTAxIDAuMzE2LDAuMTAyIDAuNjMzLDAuMjE4IDAuMzEyLDAuMTE0IDAuNjI2LDAuMjM0IDAuMzA4LDAuMTIxIDAuMzA5LDAuMTI5IDAuMzA4LDAuMTI1IDAuMTgsMC4wNzggMC4zMDEsMC4xMzMgMC42MDksMC4yNzMgMC42MDIsMC4yOSAwLjMsMC4xNDggMC4yOTcsMC4xNDggMC4yOTcsMC4xNTcgMC4yOTMsMC4xNTYgMC4yOTMsMC4xNiAwLjI5MywwLjE2NCAwLjI4OSwwLjE2NCAwLjI4OSwwLjE2OCAwLjI4NSwwLjE3MiAwLjI4NiwwLjE3NiAwLjI4MSwwLjE3NiAwLjI4MSwwLjE3OSAwLjI4MSwwLjE4NCAwLjI3OCwwLjE4NyAwLjI3MywwLjE4OCAwLjI3NCwwLjE5MSAwLjI3MywwLjE5NiAwLjI3LDAuMTk5IDAuMjY1LDAuMTk5IDAuMjY2LDAuMjAzIDAuMjYxLDAuMjAzIDAuMjYyLDAuMjA3IDAuMjYyLDAuMjExIDAuMjU0LDAuMjE1IDAuMjU4LDAuMjE1IDAuNSwwLjQzNyAwLjI1LDAuMjIzIDAuMjQ2LDAuMjI3IDAuMjQyLDAuMjI2IDAuMjQyLDAuMjMxIDAuNDc3LDAuNDY4IDAuMTM2LDAuMTM3IDAuMjMxLDAuMjM1IDAuNDYxLDAuNDg0IDAuMjI2LDAuMjQ2IDAuMjIzLDAuMjQ2IDAuMjIzLDAuMjUgMC4yMTgsMC4yNSAwLjIxNSwwLjI1NCAwLjIxNSwwLjI1OCAwLjIxMSwwLjI1OCAwLjIxMSwwLjI2MSAwLjIwNywwLjI2MiAwLjIwMywwLjI2MiAwLjE5OSwwLjI2OSAwLjIsMC4yNjYgMC4xOTUsMC4yNzMgMC4xOTUsMC4yNyAwLjE4OCwwLjI3NyAwLjE4NywwLjI3NCAwLjE4OCwwLjI4MSAwLjE3OSwwLjI3NyAwLjE4LDAuMjg1IDAuMTc2LDAuMjgyIDAuMTcyLDAuMjg1IDAuMTcyLDAuMjg5IDAuMTY4LDAuMjg5IDAuMTY0LDAuMjg5IDAuMTYsMC4yOTMgMC4xNTYsMC4yOTMgMC4xNTYsMC4yOTcgMC4xNTMsMC4yOTcgMC4xNDgsMC4yOTcgMC4xNDksMC4zIDAuMTQ0LDAuMzAxIDAuMTQxLDAuMzA1IDAuMTM2LDAuMzA1IDAuMjY2LDAuNjA5IDAuMTI1LDAuMzA1IDAuMjUsMC42MTcgMC4yMzQsMC42MjUgMC4xMTQsMC4zMTIgMC4yMTgsMC42MzMgMC4xMDIsMC4zMTcgMC4xMDIsMC4zMiAwLjA5NywwLjMxNiAwLjA5NCwwLjMyMSAwLjA5LDAuMzI0IDAuMDksMC4zMiAwLjE2NCwwLjY0OSAwLjA3OCwwLjMyNCAwLjA3NCwwLjMyNCAwLjA3LDAuMzI4IDAuMDY3LDAuMzI4IDAuMDY2LDAuMzI0IDAuMDU5LDAuMzI5IDAuMDU4LDAuMzMyIDAuMDU1LDAuMzI4IDAuMDUxLDAuMzI4IDAuMDk0LDAuNjY0IDAuMDM5LDAuMzMyIDAuMDM5LDAuMzI4IDAuMDM1LDAuMzMyIDAuMDMxLDAuMzM2IDAuMDI3LDAuMzMyIDAuMDI0LDAuMzMyIDAuMDM5LDAuNjY0IDAuMDE2LDAuMzM2IDAuMDE1LDAuNjY0IDAuMDA4LDAuMzM2IHYgMC42NiB6IE0gNjUuMTg0LDMzLjA1OSA2NS4xOCwzMi43NDIgNjUuMTcyLDMyLjQyMiA2NS4xNDgsMzEuNzg5IDY1LjEyOSwzMS40NjkgNjUuMTA5LDMxLjE1MiA2NS4wODYsMzAuODM2IDY1LjAzMSwzMC4yMDMgNjUsMjkuODg3IDY0Ljg4MywyOC45MzggNjQuODM2LDI4LjYyNSA2NC43ODksMjguMzA5IDY0LjYyNSwyNy4zNzEgNjQuNTYyLDI3LjA1OSA2NC40OTYsMjYuNzQ2IDY0LjQzLDI2LjQzOCA2NC4zNTksMjYuMTI1IDY0LjI4NSwyNS44MTYgNjQuMTI5LDI1LjE5OSA2NC4wNDcsMjQuODk1IDYzLjk1NywyNC41ODYgNjMuNzc3LDIzLjk3NyA2My42OCwyMy42NzYgNjMuNTgyLDIzLjM3MSA2My40OCwyMy4wNyA2My4zNzUsMjIuNzcgNjMuMjY2LDIyLjQ3MyA2My4xNTYsMjIuMTcyIDYzLjA0MywyMS44NzUgNjIuOTI2LDIxLjU4MiA2Mi44MDUsMjEuMjg1IDYyLjY4NCwyMC45OTYgNjIuNTU5LDIwLjcwMyA2Mi40MzQsMjAuNDE0IDYyLjMwMSwyMC4xMjEgNjIuMTY4LDE5LjgzMiA2Mi4wMzEsMTkuNTQ3IDYxLjc1LDE4Ljk3NyA2MS42MDIsMTguNjkxIDYxLjQ1NywxOC40MSA2MS4zMDUsMTguMTMzIDYxLjE1MiwxNy44NTIgNjAuOTk2LDE3LjU3OCA2MC44MzYsMTcuMzAxIDYwLjUwOCwxNi43NTQgNjAuMTcyLDE2LjIxNSA1OS45OTYsMTUuOTQ5IDU5LjgyNCwxNS42ODQgNTkuNDY1LDE1LjE2IDU5LjI4MSwxNC45MDIgNTkuMDk0LDE0LjY0NSA1OC45MDIsMTQuMzg3IDU4LjcxMSwxNC4xMzMgNTguNTIsMTMuODgzIDU4LjEyMSwxMy4zODMgNTcuOTIyLDEzLjEzNyA1Ny43MTksMTIuODk1IDU3LjUxMiwxMi42NTIgNTcuMzAxLDEyLjQxIDU3LjA5LDEyLjE3MiA1Ni42NiwxMS43MDMgNTYuMjIzLDExLjI0MiA1NiwxMS4wMTIgNTUuODcxLDEwLjg4NyA1NS42NDUsMTAuNjYgNTUuNDE4LDEwLjQzOCA1NS4xODQsMTAuMjE5IDU0Ljk1MywxMC4wMDQgNTQuNzE5LDkuNzg5IDU0LjQ4LDkuNTc0IDU0LjI0Miw5LjM2MyA1NC4wMDQsOS4xNTYgNTMuNzU4LDguOTQ5IDUzLjUxNiw4Ljc0NiA1My4yNyw4LjU0NyA1My4wMiw4LjM0OCA1Mi43Nyw4LjE1MiA1Mi4yNjIsNy43NyA1Mi4wMDQsNy41ODIgNTEuNzQ2LDcuMzk4IDUxLjQ4NCw3LjIxNSA1MC45NjEsNi44NTUgNTAuNjk1LDYuNjg0IDUwLjE1Niw2LjM0IDQ5Ljg4Nyw2LjE3NiA0OS42MTMsNi4wMTIgNDkuMzQsNS44NTIgNDkuMDYyLDUuNjkxIDQ4LjUwOCw1LjM4NyA0OC4yMjcsNS4yMzQgNDcuOTQ1LDUuMDkgNDcuNjYsNC45NDUgNDcuMDksNC42NjQgNDYuNTEyLDQuMzk4IDQ2LjIxOSw0LjI2NiA0NS45MjYsNC4xNDEgNDUuNzYyLDQuMDY2IDQ1LjQ2OSwzLjk0NSA0NS4xNzIsMy44MjQgNDQuODc1LDMuNzExIDQ0LjU3OCwzLjU5NCA0NC4yODEsMy40ODQgNDMuOTgsMy4zNzUgNDMuNjg0LDMuMjczIDQzLjM3OSwzLjE2OCA0My4wNzgsMy4wNyA0Mi43NzMsMi45NzcgNDIuNDczLDIuODgzIDQyLjE2NCwyLjc5MyA0MS41NTUsMi42MjEgNDAuOTM4LDIuNDY1IDQwLjYyOSwyLjM5MSA0MC4zMTYsMi4zMiA0MC4wMDgsMi4yNTQgMzkuNjk1LDIuMTg4IDM5LjA3LDIuMDcgMzguNzU4LDIuMDE2IDM4LjQ0NSwxLjk2NSAzOC4xMjksMS45MTQgMzcuODE2LDEuODcxIDM3LjUsMS44MjggMzcuMTg0LDEuNzg5IDM2LjU1MSwxLjcxOSAzNS45MTgsMS42NjQgMzUuNjAyLDEuNjQxIDM1LjI4MSwxLjYyMSAzNC42NDgsMS41OSAzNC4zMjgsMS41NzggMzQuMDEyLDEuNTcgMzMuNjkxLDEuNTY2IEggMzMuMDYyIEwgMzIuNzQyLDEuNTcgMzIuNDI2LDEuNTc4IDMyLjEwNSwxLjU5IDMxLjc4OSwxLjYwNSAzMS40NjksMS42MjEgMzEuMTUyLDEuNjQxIDMwLjgzNiwxLjY2NCAzMC4yMDMsMS43MTkgMjkuNTcsMS43ODkgMjguOTM4LDEuODY3IDI4LjYyNSwxLjkxNCAyOC4zMDksMS45NjEgMjcuNjg0LDIuMDcgMjcuMDU5LDIuMTg4IDI2Ljc0NiwyLjI1NCAyNi40MzgsMi4zMiAyNi4xMjUsMi4zOTEgMjUuODE2LDIuNDY1IDI1LjE5OSwyLjYyMSAyNC44OTUsMi43MDcgMjQuNTg2LDIuNzkzIDIzLjk3NywyLjk3MyAyMy42NzYsMy4wNyAyMy4zNzEsMy4xNjggMjMuMDcsMy4yNyAyMi43NywzLjM3NSAyMi40NzMsMy40ODQgMjIuMTcyLDMuNTk0IDIxLjg3NSwzLjcwNyAyMS41ODIsMy44MjQgMjEuMjg1LDMuOTQ1IDIwLjk5Niw0LjA2NiAyMC43MDMsNC4xOTEgMjAuNDE0LDQuMzIgMjAuMTIxLDQuNDQ5IDE5LjgzNiw0LjU4MiAxOS41NDcsNC43MTkgMTkuMjYyLDQuODU5IDE4LjY5MSw1LjE0OCAxOC40MSw1LjI5NyAxOC4xMzMsNS40NDUgMTcuODUyLDUuNjAyIDE3LjU3OCw1Ljc1OCAxNy4zMDEsNS45MTQgMTYuNzU0LDYuMjQyIDE2LjIxNSw2LjU3OCAxNS42ODQsNi45MyAxNS40MjIsNy4xMDUgMTUuMTYsNy4yODkgbCAtMC41MTUsMC4zNjcgLTAuMjU4LDAuMTkyIC0wLjI1NCwwLjE5MSAtMC4yNSwwLjE5MSAtMC41LDAuMzk5IC0wLjI0NiwwLjE5OSAtMC4yNDIsMC4yMDcgLTAuMjQzLDAuMjAzIC0wLjI0MiwwLjIxMSAtMC4yMzgsMC4yMTEgLTAuNDY5LDAuNDMgLTAuNDYxLDAuNDM3IC0wLjIyNiwwLjIyNyAtMC4xMjksMC4xMjUgLTAuMjI3LDAuMjI2IC0wLjIxOSwwLjIzMSAtMC4yMjIsMC4yMyAtMC4yMTUsMC4yMzEgTCA5Ljc4OSwxMi4wMzEgOS41NzQsMTIuMjcgOS4zNjMsMTIuNTA4IDguOTQ5LDEyLjk5MiA4Ljc0NiwxMy4yMzQgOC41NDcsMTMuNDg0IDguMzQ4LDEzLjczIDguMTUyLDEzLjk4IDcuNzcsMTQuNDg4IDcuNTgyLDE0Ljc0NiA3LjM5OCwxNS4wMDQgNy4yMTUsMTUuMjY2IDYuODU1LDE1Ljc4OSA2LjY4NCwxNi4wNTkgNi41MTIsMTYuMzI0IDYuMTc2LDE2Ljg2MyA2LjAxMiwxNy4xMzcgNS44NTIsMTcuNDEgNS42OTEsMTcuNjg4IDUuMzg3LDE4LjI0MiA1LjIzNCwxOC41MjMgNS4wOSwxOC44MDkgNC45NDUsMTkuMDkgNC42NjQsMTkuNjYgNC4zOTgsMjAuMjM4IDQuMjY2LDIwLjUzMSA0LjE0MSwyMC44MjQgNC4wNjYsMjAuOTg4IDMuOTQ1LDIxLjI4MSAzLjgyNCwyMS41NzggMy43MTEsMjEuODc1IDMuNTk0LDIyLjE3MiAzLjQ4NCwyMi40NjkgMy4zNzUsMjIuNzcgMy4yNzMsMjMuMDcgMy4xNjgsMjMuMzcxIDMuMDcsMjMuNjcyIDIuODgzLDI0LjI4MSAyLjc5MywyNC41ODYgMi43MDcsMjQuODkxIDIuNjIxLDI1LjE5OSAyLjU0MywyNS41MDQgMi40NjUsMjUuODEyIDIuMzkxLDI2LjEyMSAyLjMyLDI2LjQzNCAyLjI1NCwyNi43NDIgMi4xODgsMjcuMDU1IDIuMDcsMjcuNjggMi4wMTYsMjcuOTkyIDEuOTY1LDI4LjMwNSAxLjkxNCwyOC42MjEgMS44NzEsMjguOTM0IDEuODI4LDI5LjI1IDEuNzg5LDI5LjU2NiAxLjcxOSwzMC4xOTkgMS42NjQsMzAuODMyIDEuNjQxLDMxLjE0OCAxLjYyMSwzMS40NjkgMS41OSwzMi4xMDIgMS41NzgsMzIuNDIyIDEuNTcsMzIuNzM4IDEuNTY2LDMzLjA1OSB2IDAuNjMyIGwgMC4wMDQsMC4zMTcgMC4wMDgsMC4zMiAwLjAxMiwwLjMxNyAwLjAxNSwwLjMxNiAwLjAxNiwwLjMyIDAuMDIsMC4zMTcgMC4wMjMsMC4zMTYgMC4wMjcsMC4zMTYgMC4wMjgsMC4zMjEgMC4wMzUsMC4zMTYgMC4wMzUsMC4zMTMgMC4wNzgsMC42MzIgMC4wNDcsMC4zMTcgMC4wNDcsMC4zMTIgMC4xMDksMC42MjUgMC4xMTgsMC42MjUgMC4xMzIsMC42MjUgMC4wNzEsMC4zMDkgMC4wNzQsMC4zMDkgMC4xNTYsMC42MTcgMC4wODYsMC4zMDQgMC4wODYsMC4zMDkgMC4xOCwwLjYwOSAwLjA5NywwLjMwMSAwLjA5OCwwLjMwNSAwLjEwMiwwLjMwMSAwLjEwNSwwLjMgMC4xMDksMC4yOTcgMC4xMSwwLjMwMSAwLjExMywwLjI5NyAwLjExNywwLjI5MyAwLjEyMSwwLjI5NyAwLjEyMSwwLjI4OSAwLjEyNSwwLjI5MyAwLjEyOSwwLjI4OSAwLjEyOSwwLjI5MyAwLjEzMywwLjI4OSAwLjEzNywwLjI4NSAwLjE0LDAuMjg1IDAuMjg5LDAuNTcxIDAuMTQ5LDAuMjgxIDAuMTQ4LDAuMjc3IDAuMTU3LDAuMjgxIDAuMTU2LDAuMjc4IDAuMTU2LDAuMjczIDAuMzI4LDAuNTQ3IDAuMzM2LDAuNTM5IDAuMzUyLDAuNTMxIDAuMTc1LDAuMjYyIDAuMzY4LDAuNTI0IDAuMTgzLDAuMjU3IDAuNTc0LDAuNzYyIDAuMiwwLjI1IDAuMzk4LDAuNDkyIDAuMjA3LDAuMjQyIDAuMjAzLDAuMjQzIDAuMjExLDAuMjQyIDAuMjExLDAuMjM4IDAuNDMsMC40NjkgMC40MzcsMC40NjEgMC4yMjcsMC4yMyAwLjM1MSwwLjM1MiAwLjIzMSwwLjIyMiAwLjIzLDAuMjE5IDAuMjMxLDAuMjE1IDAuMjM0LDAuMjE5IDAuNDc3LDAuNDIyIDAuNDg0LDAuNDE0IDAuMjQyLDAuMjAzIDAuMjUsMC4xOTkgMC4yNDYsMC4xOTkgMC4yNSwwLjE5NiAwLjUwOCwwLjM4MiAwLjI1OCwwLjE4OCAwLjI1OCwwLjE4NCAwLjI2MiwwLjE4MyAwLjI2MSwwLjE4IDAuMjY2LDAuMTggMC41MzEsMC4zNDMgMC4yNywwLjE3MiAwLjI2OSwwLjE2NCAwLjI3NCwwLjE2NCAwLjI3MywwLjE2IDAuMjc4LDAuMTYxIDAuMjc3LDAuMTUyIDAuMjgxLDAuMTU2IDAuMjc3LDAuMTQ5IDAuMjg2LDAuMTQ0IDAuMjgxLDAuMTQ1IDAuMjg1LDAuMTQgMC4yODksMC4xNDEgMC4yODUsMC4xMzcgMC4yODksMC4xMzIgMC41ODYsMC4yNTggMC4xNjQsMC4wNzEgMC4yOTcsMC4xMjEgMC4yOTMsMC4xMjEgMC4yOTcsMC4xMTcgMC4yOTcsMC4xMTMgMC4yOTcsMC4xMSAwLjMwMSwwLjEwOSAwLjMsMC4xMDUgMC4zMDEsMC4xMDIgMC4zMDEsMC4wOTggMC42MDksMC4xODcgMC4zMDUsMC4wOSAwLjMwNSwwLjA4NiAwLjMwOCwwLjA4NiAwLjMwNSwwLjA3OCAwLjMwOCwwLjA3OCAwLjMwOSwwLjA3NCAwLjMxMywwLjA3MSAwLjMwOCwwLjA2NiAwLjMxMywwLjA2NiAwLjYyNSwwLjExOCAwLjYyNSwwLjEwOSAwLjMxNiwwLjA0NyAwLjMxMywwLjA0NyAwLjYzMiwwLjA3OCAwLjYzMywwLjA3IDAuNjMzLDAuMDU1IDAuMzE2LDAuMDIzIDAuMzIxLDAuMDIgMC42MzMsMC4wMzEgMC4zMiwwLjAxMiAwLjMxNiwwLjAwOCAwLjMyMSwwLjAwNCBoIDAuNjMyIGwgMC4zMTcsLTAuMDA0IDAuMzIsLTAuMDA4IDAuMzE3LC0wLjAxMiAwLjMxNiwtMC4wMTUgMC4zMiwtMC4wMTYgMC4zMTcsLTAuMDIgMC4zMTYsLTAuMDIzIDAuMzE2LC0wLjAyNyAwLjMyMSwtMC4wMjggMC4zMTYsLTAuMDMxIDAuMzEzLC0wLjAzOSAwLjYzMiwtMC4wNzggMC4zMTcsLTAuMDQ3IDAuMzEyLC0wLjA0NyAwLjkzOCwtMC4xNjQgMC4zMTIsLTAuMDYzIDAuNjI1LC0wLjEzMiAwLjMwOSwtMC4wNzEgMC4zMDksLTAuMDc0IDAuNjE3LC0wLjE1NiAwLjMwNCwtMC4wODIgMC4zMDksLTAuMDkgMC42MDksLTAuMTggMC4zMDEsLTAuMDk3IDAuMzA1LC0wLjA5OCAwLjMwMSwtMC4xMDIgMC4zLC0wLjEwNSAwLjI5NywtMC4xMDkgMC4zMDEsLTAuMTEgMC4yOTcsLTAuMTEzIDAuMjk3LC0wLjExNyAwLjI5MywtMC4xMjEgMC4yODksLTAuMTIxIDAuNTg2LC0wLjI1IDAuNTc4LC0wLjI2NiAwLjI4NSwtMC4xMzcgMC41NywtMC4yODEgMC4yODYsLTAuMTQ4IDAuMjgxLC0wLjE0OSAwLjI3NywtMC4xNDggMC4yODEsLTAuMTUzIDAuMjc4LC0wLjE1NiAwLjI3MywtMC4xNiAwLjU0NywtMC4zMjggMC41MzksLTAuMzM2IDAuMjY2LC0wLjE3NiAwLjI2NSwtMC4xNzIgMC41MjQsLTAuMzU5IDAuMjYyLC0wLjE4OCAwLjI1NywtMC4xODMgMC43NjIsLTAuNTc0IDAuMjUsLTAuMiAwLjQ5MiwtMC4zOTggMC4yNDYsLTAuMjAzIDAuMjM5LC0wLjIwNyAwLjI0MiwtMC4yMTEgMC4yMzgsLTAuMjExIDAuNDY5LC0wLjQzIDAuNDYxLC0wLjQzNyAwLjIzLC0wLjIyNyAwLjM1MiwtMC4zNTEgMC4yMjIsLTAuMjMxIDAuNDM4LC0wLjQ2MSAwLjIxNSwtMC4yMzQgMC40MjIsLTAuNDc3IDAuMjA3LC0wLjIzOCAwLjIwNywtMC4yNDYgMC4yMDMsLTAuMjQyIDAuMTk5LC0wLjI0NiAwLjE5OSwtMC4yNSAwLjE5NiwtMC4yNSAwLjM4MiwtMC41MDggMC4xODgsLTAuMjU4IDAuMTg0LC0wLjI1OCAwLjE4MywtMC4yNjIgMC4zNiwtMC41MjMgMC4xNzEsLTAuMjY2IDAuMzQ0LC0wLjUzOSAwLjE2NCwtMC4yNjkgMC4xNjQsLTAuMjc0IDAuMTYsLTAuMjczIDAuMTYxLC0wLjI3OCAwLjE1MiwtMC4yNzcgMC4xNTYsLTAuMjc3IDAuMTQ5LC0wLjI4MSAwLjE0NCwtMC4yODIgMC4xNDUsLTAuMjg1IDAuMjgxLC0wLjU3IDAuMTM3LC0wLjI4OSAwLjEzMiwtMC4yODkgMC4yNTgsLTAuNTg2IDAuMDcxLC0wLjE2NCAwLjEyMSwtMC4yOTMgMC4xMjEsLTAuMjk3IDAuMTE3LC0wLjI5NyAwLjExMywtMC4yOTcgMC4xMSwtMC4yOTcgMC4xMDksLTAuMzAxIDAuMTA1LC0wLjI5NiAwLjEwMiwtMC4zMDUgMC4wOTgsLTAuMzAxIDAuMDk3LC0wLjMwNSAwLjA5LC0wLjMgMC4wOSwtMC4zMDkgMC4xNzIsLTAuNjA5IDAuMTU2LC0wLjYxNyAwLjA3NCwtMC4zMDkgMC4wNzEsLTAuMzEzIDAuMDY2LC0wLjMwOCAwLjA2NiwtMC4zMTMgMC4xMTgsLTAuNjI1IDAuMTA5LC0wLjYyNSAwLjA0NywtMC4zMTYgMC4wNDcsLTAuMzEzIDAuMDc4LC0wLjYzMiAwLjA3LC0wLjYzMyAwLjA1NSwtMC42MzMgMC4wMjMsLTAuMzE2IDAuMDIsLTAuMzIxIDAuMDMxLC0wLjYzMyAwLjAxMiwtMC4zMiAwLjAwOCwtMC4zMTYgMC4wMDQsLTAuMzIxIHoiCiAgICAgICAgIHN0eWxlPSJmaWxsOiNjNGQ2MDA7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmUiCiAgICAgICAgIGlkPSJwYXRoODU0IiAvPjwvZz48L2c+PC9zdmc+Cg=="
        };
    }

    protected override void OnTargetFileStreamInitialized(Stream targetFileStream)
    {
        _htmlWriter = CreateMessagesToHtmlWriter(
            targetFileStream,
            async (sw, e) => await sw.WriteAsync(NdjsonSerializer.Serialize(e)));
    }

    protected override void OnTargetFileStreamDisposing()
    {
        _htmlWriter?.Dispose();
        _htmlWriter = null;
    }

    protected override async Task FlushTargetFileStream(CancellationToken cancellationToken)
    {
        if (_htmlWriter != null)
        {
            await _htmlWriter.DisposeAsync();
            _htmlWriter = null;
            // We should not call base.FlushTargetFileStream here because the HtmlWriter already disposed the stream
            // and the stream's flush operation would throw an exception.
        }
        else
        {
            await base.FlushTargetFileStream(cancellationToken);
        }
    }

    protected override async Task WriteToFile(Envelope envelope, CancellationToken cancellationToken)
    {
        if (_htmlWriter != null)
        {
            await _htmlWriter.WriteAsync(envelope);
        }
    }
}